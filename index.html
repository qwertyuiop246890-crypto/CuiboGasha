<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuibo Gasha WMS Pro v2.2</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Babel for JSX (Pinned version to prevent target errors) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>

    <!-- 3. Load External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- 4. Configure Tailwind Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: { 50: '#FFFBF5', 100: '#FCF4E9', 200: '#EBE0D6', 300: '#D3C5BC' },
                        latte: { 400: '#B5A496', 500: '#957E6B', 600: '#8C6A5D', 800: '#5E4B41', 900: '#4A3B32' }
                    },
                    boxShadow: { 'soft': '0 4px 20px -5px rgba(149, 126, 107, 0.1)' },
                    animation: { 'in': 'fadeIn 0.2s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.98)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FCF4E9; color: #5E4B41; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Hidden receipt container - specific styling for html2canvas capture */
        #hidden-receipt-container { position: fixed; top: 0; left: -9999px; width: 500px; background-color: #FCF4E9; z-index: -100; padding: 40px; }
        .receipt-card { background: #fff; padding: 30px; border-radius: 20px; border: 1px solid #EBE0D6; }
        .receipt-header { text-align: center; border-bottom: 2px dashed #D3C5BC; padding-bottom: 20px; margin-bottom: 20px; }
        .receipt-title { font-size: 24px; font-weight: 900; color: #5E4B41; }
        .receipt-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: 700; color: #8C6A5D; }
        .receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .receipt-table th { text-align: left; padding-bottom: 8px; border-bottom: 1px solid #EBE0D6; color: #957E6B; font-size: 12px; }
        .receipt-table td { padding: 10px 0; border-bottom: 1px dashed #EBE0D6; vertical-align: top; }
        .receipt-summary { background: #FFFBF5; padding: 20px; border-radius: 12px; text-align: right; border: 1px solid #EBE0D6; font-weight: 900; color: #957E6B; font-size: 20px; }
        .receipt-footer { margin-top: 30px; text-align: center; font-size: 12px; color: #B5A496; font-weight: bold; }
        
        .price-btn-active { background-color: #957E6B; color: #FFFBF5; border-color: #957E6B; }
        .price-btn { background-color: #FFFBF5; color: #B5A496; border: 1px solid #EBE0D6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, ShoppingBag, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Truck, DollarSign, Search, X, ChevronRight, ClipboardList, 
            User, ListOrdered, Tag, CheckSquare, Trash2, Edit, Save, 
            Image as ImageIcon, Download, Loader2, Coins, Circle, ShoppingCart, Settings,
            Cloud, Upload, FileJson, FileSpreadsheet, RefreshCcw, Minus, ArrowRightCircle, Megaphone, Undo2, History, Package, RotateCcw,
            FileArchive, Square
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            // 1. Settings & Constants
            const DEFAULT_PRICE_TABLE = { 100: 50, 200: 80, 300: 120, 400: 140, 500: 170, 600: 190, 800: 260, 1000: 360, 1500: 450 };
            const ECO_FEE = 10; 
            const RELEASE_ZONE_NAME = "ÈáãÂá∫ÂçÄ";
            const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzUzREPd7UAzndt6i4qN70nkd1ZUJWdzJa3DbQjN7yFZeJ2ne5Nj9f767-tMSaB7ayI/exec";

            // 2. State Management
            const loadLocal = (key, def) => { 
                const s = localStorage.getItem(key); 
                try {
                    return s ? JSON.parse(s) : def; 
                } catch(e) { return def; }
            };
            const [orders, setOrders] = useState(() => loadLocal('cuibo_gasha_orders', []));
            const [priceTable, setPriceTable] = useState(() => {
                const loaded = loadLocal('cuibo_gasha_pricetable', null);
                if (!loaded || Object.keys(loaded).length === 0) return DEFAULT_PRICE_TABLE;
                return loaded;
            });
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem('cuibo_gasha_api_url') || DEFAULT_API_URL);
            
            // History (Ensuring structure)
            const [history, setHistory] = useState(() => {
                const h = loadLocal('cuibo_gasha_history', { machines: [], customers: [], variants: [] });
                return {
                    machines: Array.isArray(h.machines) ? h.machines : [],
                    customers: Array.isArray(h.customers) ? h.customers : [],
                    variants: Array.isArray(h.variants) ? h.variants : []
                };
            });

            const [currentMachine, setCurrentMachine] = useState({ name: '', priceJPY: 500, priceTWD: 170, variant: '' });
            const [inputCustomer, setInputCustomer] = useState('');
            const [inputQty, setInputQty] = useState(1);
            const [isEco, setIsEco] = useState(false);

            const [activeTab, setActiveTab] = useState('input'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCustomerName, setSelectedCustomerName] = useState(null); 
            const [notification, setNotification] = useState(null);
            
            // Export & Batch States
            const [exportTargetCustomer, setExportTargetCustomer] = useState(null);
            const [isBatchExporting, setIsBatchExporting] = useState(false);
            const [batchProgress, setBatchProgress] = useState('');
            const [selectedForExport, setSelectedForExport] = useState(new Set());
            
            const [isSyncing, setIsSyncing] = useState(false);
            
            const [showPriceEditor, setShowPriceEditor] = useState(false);
            const [editingPrices, setEditingPrices] = useState([]);
            const [showGlobalSettings, setShowGlobalSettings] = useState(false);
            
            const [showDashboardDetail, setShowDashboardDetail] = useState(null); 
            const [dashboardSearchQuery, setDashboardSearchQuery] = useState(''); 
            const [statusUpdateData, setStatusUpdateData] = useState(null); 
            const [statusUpdateQty, setStatusUpdateQty] = useState(1);

            const [editingOrder, setEditingOrder] = useState(null); 
            const [transferringOrder, setTransferringOrder] = useState(null); 
            const [transferTarget, setTransferTarget] = useState(''); 
            const [transferQty, setTransferQty] = useState(1);
            
            const [releasingOrder, setReleasingOrder] = useState(null); 
            const [releaseQty, setReleaseQty] = useState(1);

            const [confirmConfig, setConfirmConfig] = useState(null);
            const fileInputRef = useRef(null);

            // Persistence
            useEffect(() => { localStorage.setItem('cuibo_gasha_orders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_pricetable', JSON.stringify(priceTable)); }, [priceTable]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_api_url', apiUrl); }, [apiUrl]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_history', JSON.stringify(history)); }, [history]);

            // Clear selection on tab change
            useEffect(() => {
                if(activeTab !== 'customers') setSelectedForExport(new Set());
            }, [activeTab]);

            // 3. Logic & Computed Values
            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
            const triggerConfirm = (title, message, onConfirm, type = 'info') => { setConfirmConfig({ title, message, onConfirm, type }); };

            const updateHistory = (type, value) => {
                if (!value) return;
                const val = value.trim();
                setHistory(prev => {
                    const list = prev[type] || [];
                    const newList = [val, ...list.filter(item => item && item !== val)].slice(0, 100); 
                    return { ...prev, [type]: newList };
                });
            };

            const customerList = useMemo(() => {
                const map = {};
                orders.forEach(o => {
                    const cleanName = o.customer ? o.customer.trim() : 'Unknown';
                    if (!map[cleanName]) map[cleanName] = { name: cleanName, totalSpent: 0, items: [], orderCount: 0 };
                    map[cleanName].orderCount += 1;
                    map[cleanName].totalSpent += o.customerTotalTWD;
                    map[cleanName].items.push({ ...o, itemTotal: o.customerTotalTWD, finalPrice: o.unitPriceTWD });
                });
                return Object.values(map).sort((a,b) => b.totalSpent - a.totalSpent);
            }, [orders]);

            const activeCustomerDetail = useMemo(() => {
                if (!selectedCustomerName) return null;
                return customerList.find(c => c.name === selectedCustomerName) || { name: selectedCustomerName, totalSpent: 0, items: [] };
            }, [customerList, selectedCustomerName]);

            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            
            const stats = useMemo(() => {
                const totalRevenue = orders.reduce((acc, o) => acc + o.customerTotalTWD, 0);
                const totalJPY = orders.reduce((acc, o) => acc + o.gashaTotalJPY, 0);
                const totalCount = orders.reduce((acc, o) => acc + o.qty, 0);
                const pendingPurchase = orders.filter(o => !o.isPurchased && !o.isReleasing).reduce((acc, o) => acc + o.qty, 0);
                const pendingPick = orders.filter(o => o.isPurchased && !o.isPicked && !o.isReleasing).reduce((acc, o) => acc + o.qty, 0);
                const releasingCount = orders.filter(o => o.isReleasing).reduce((acc, o) => acc + o.qty, 0);
                return { totalRevenue, totalJPY, totalCount, pendingPurchase, pendingPick, releasingCount };
            }, [orders]);

            const filteredOrders = orders.filter(o => o.customer.includes(searchQuery) || o.productName.includes(searchQuery) || (o.variant && o.variant.includes(searchQuery)));

            const getDashboardDetailOrders = () => {
                let list = [];
                if (showDashboardDetail === 'purchase') {
                    list = orders.filter(o => !o.isPurchased && !o.isReleasing);
                } else if (showDashboardDetail === 'pick') {
                    list = orders.filter(o => o.isPurchased && !o.isPicked && !o.isReleasing);
                } else if (showDashboardDetail === 'releasing') {
                    list = orders.filter(o => o.isReleasing);
                }
                
                if (dashboardSearchQuery) list = list.filter(o => o.customer.includes(dashboardSearchQuery) || o.productName.includes(dashboardSearchQuery));
                return list.sort((a, b) => a.productName.localeCompare(b.productName));
            };

            const uniqueCustomersInDashboard = useMemo(() => {
                const list = getDashboardDetailOrders();
                return [...new Set(list.map(o => o.customer))].sort();
            }, [orders, showDashboardDetail, dashboardSearchQuery]);

            // 4. Handlers
            const handlePriceSelect = (jpy) => setCurrentMachine(p => ({ ...p, priceJPY: jpy, priceTWD: priceTable[jpy] || 0 }));
            
            const addOrder = () => {
                if (!inputCustomer.trim()) return notify("Ë´ãËº∏ÂÖ•È°ßÂÆ¢ÂêçÁ®±");
                if (!currentMachine.name.trim()) return notify("Ë´ãËº∏ÂÖ•Ê©üÂè∞ÂêçÁ®±");
                if (!currentMachine.variant.trim()) return notify("Ë´ãËº∏ÂÖ•Ê¨æÂºè");

                const unitPriceTWD = currentMachine.priceTWD;
                const ecoTotal = isEco ? (ECO_FEE * inputQty) : 0;
                
                updateHistory('machines', currentMachine.name);
                updateHistory('customers', inputCustomer);
                updateHistory('variants', currentMachine.variant);

                const newOrder = {
                    id: Date.now(), date: new Date().toISOString().split('T')[0],
                    customer: inputCustomer.trim(), productName: currentMachine.name, variant: currentMachine.variant.trim(), qty: inputQty,
                    unitPriceJPY: currentMachine.priceJPY, unitPriceTWD: unitPriceTWD,
                    ecoFeePerUnit: isEco ? ECO_FEE : 0, ecoFeeTotal: ecoTotal,
                    gashaTotalJPY: currentMachine.priceJPY * inputQty, gashaTotalTWD: unitPriceTWD * inputQty, customerTotalTWD: (unitPriceTWD * inputQty) + ecoTotal,
                    isPurchased: false, isPicked: false, isReleasing: false
                };
                setOrders(p => [newOrder, ...p]);
                setInputCustomer(''); setInputQty(1); notify(`Â∑≤Âä†ÂÖ•: ${newOrder.customer}`);
            };

            const toggleStatus = (id, field) => setOrders(p => p.map(o => o.id === id ? { ...o, [field]: !o[field] } : o));
            const deleteOrder = (id) => triggerConfirm('Âà™Èô§', 'Á¢∫ÂÆöÂà™Èô§Ê≠§Ë®ÇÂñÆÔºü', () => { setOrders(p => p.filter(o => o.id !== id)); notify("Â∑≤Âà™Èô§"); }, 'danger');
            
            const handleMarkAsReleasing = () => {
                if (!releasingOrder) return;
                const qtyToRelease = parseInt(releaseQty);
                if (qtyToRelease <= 0 || qtyToRelease > releasingOrder.qty) return notify("Êï∏ÈáèÈåØË™§");

                setOrders(prev => {
                    if (qtyToRelease === releasingOrder.qty) return prev.map(o => o.id === releasingOrder.id ? { ...o, isReleasing: true } : o);
                    const updatedOrders = [];
                    const ecoNew = releasingOrder.ecoFeePerUnit * qtyToRelease;
                    updatedOrders.push({
                        ...releasingOrder, id: Date.now(), qty: qtyToRelease, ecoFeeTotal: ecoNew,
                        gashaTotalJPY: releasingOrder.unitPriceJPY * qtyToRelease, gashaTotalTWD: releasingOrder.unitPriceTWD * qtyToRelease,
                        customerTotalTWD: (releasingOrder.unitPriceTWD * qtyToRelease) + ecoNew, isReleasing: true
                    });
                    prev.forEach(o => {
                        if (o.id === releasingOrder.id) {
                            const left = o.qty - qtyToRelease;
                            updatedOrders.push({ ...o, qty: left, ecoFeeTotal: o.ecoFeePerUnit * left, gashaTotalJPY: o.unitPriceJPY * left, gashaTotalTWD: o.unitPriceTWD * left, customerTotalTWD: (o.unitPriceTWD * left) + (o.ecoFeePerUnit * left) });
                        } else updatedOrders.push(o);
                    });
                    return updatedOrders;
                });
                setReleasingOrder(null); setReleaseQty(1); notify(`Â∑≤Ê®ôË®ò ${qtyToRelease} ÂÄãÁÇ∫ÈáãÂá∫‰∏≠`);
            };
            
            const handleCancelRelease = (id) => {
                setOrders(prev => {
                    const target = prev.find(o => o.id === id);
                    if (!target) return prev;
                    const siblingIndex = prev.findIndex(o => o.id !== id && o.customer === target.customer && o.productName === target.productName && o.variant === target.variant && o.unitPriceTWD === target.unitPriceTWD && o.ecoFeePerUnit === target.ecoFeePerUnit && o.isPurchased === target.isPurchased && o.isPicked === target.isPicked && o.isReleasing === false);
                    if (siblingIndex !== -1) {
                        const sibling = prev[siblingIndex];
                        const newQty = sibling.qty + target.qty;
                        const ecoTotal = sibling.ecoFeePerUnit * newQty;
                        const mergedOrder = { ...sibling, qty: newQty, ecoFeeTotal: ecoTotal, gashaTotalJPY: sibling.unitPriceJPY * newQty, gashaTotalTWD: sibling.unitPriceTWD * newQty, customerTotalTWD: (sibling.unitPriceTWD * newQty) + ecoTotal };
                        const newOrders = [...prev]; newOrders[siblingIndex] = mergedOrder; return newOrders.filter(o => o.id !== id);
                    } else {
                        return prev.map(o => o.id === id ? { ...o, isReleasing: false } : o);
                    }
                });
                notify("Â∑≤ÂèñÊ∂àÈáãÂá∫");
            };

            const handleTransferOrder = () => {
                if (!transferringOrder || !transferTarget) return;
                const target = transferTarget.trim();
                const qty = parseInt(transferQty);
                if (qty <= 0 || qty > transferringOrder.qty) return notify("Êï∏ÈáèÈåØË™§");
                
                updateHistory('customers', target);

                triggerConfirm('Á¢∫Ë™çËΩâËÆì', `Â∞á ${qty} ÂÄãËΩâËÆìÁµ¶„Äå${target}„ÄçÔºü\nÊâÄÊúâÊ¨äÂ∞áÁ´ãÂç≥ËΩâÁßªÔºå‰∏¶ÂèñÊ∂àÈáãÂá∫ÁãÄÊÖã„ÄÇ`, () => {
                    setOrders(prev => {
                        if (qty === transferringOrder.qty) return prev.map(o => o.id === transferringOrder.id ? { ...o, customer: target, isReleasing: false } : o);
                        const updated = [];
                        const ecoNew = transferringOrder.ecoFeePerUnit * qty;
                        updated.push({ ...transferringOrder, id: Date.now(), customer: target, qty: qty, ecoFeeTotal: ecoNew, gashaTotalJPY: transferringOrder.unitPriceJPY*qty, gashaTotalTWD: transferringOrder.unitPriceTWD*qty, customerTotalTWD: (transferringOrder.unitPriceTWD*qty)+ecoNew, isReleasing: false });
                        prev.forEach(o => {
                            if (o.id === transferringOrder.id) {
                                const left = o.qty - qty;
                                updated.push({ ...o, qty: left, ecoFeeTotal: o.ecoFeePerUnit*left, gashaTotalJPY: o.unitPriceJPY*left, gashaTotalTWD: o.unitPriceTWD*left, customerTotalTWD: (o.unitPriceTWD*left)+(o.ecoFeePerUnit*left) });
                            } else updated.push(o);
                        });
                        return updated;
                    });
                    setTransferringOrder(null); setTransferTarget(''); notify(`Â∑≤ËΩâËÆìÁµ¶ ${target}`);
                });
            };

            const handleClearAllData = () => {
                triggerConfirm('‚ö†Ô∏è Âç±Èö™Êìç‰Ωú', 'Ê≠§Êìç‰ΩúÂ∞á„ÄåÊ∞∏‰πÖÊ∏ÖÈô§ÊâÄÊúâË®ÇÂñÆË≥áÊñô„ÄçÔºÅ\n(ÂÉπÊ†ºË®≠ÂÆöËàáËº∏ÂÖ•Ê≠∑Âè≤ÊúÉ‰øùÁïô)\n\nÊÇ®Á¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü', () => {
                    setOrders([]); notify("Á≥ªÁµ±Ë≥áÊñôÂ∑≤Ê∏ÖÁ©∫"); setShowGlobalSettings(false);
                }, 'danger');
            };

            const handleClearHistory = () => {
                triggerConfirm('Ê∏ÖÈô§Ê≠∑Âè≤', 'Á¢∫ÂÆöÊ∏ÖÈô§ÊâÄÊúâËá™ÂãïÂÆåÊàêÁöÑÊ≠∑Âè≤Á¥ÄÈåÑÔºü', () => {
                    setHistory({ machines: [], customers: [], variants: [] });
                    notify("Ê≠∑Âè≤Á¥ÄÈåÑÂ∑≤Ê∏ÖÁ©∫");
                }, 'danger');
            };

            const handleExportBackup = () => { saveAs(new Blob([JSON.stringify({ orders, priceTable, history, timestamp: new Date().toISOString() }, null, 2)], { type: "application/json" }), `CuiboGasha_Backup_${new Date().toISOString().slice(0,10)}.json`); notify("‰∏ãËºâÊàêÂäü"); };
            const handleImportBackup = (e) => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload=(ev)=>{ try{ const d=JSON.parse(ev.target.result); if(d.orders) triggerConfirm('ÈÇÑÂéü', `ÊôÇÈñì: ${d.timestamp}`, ()=>{ setOrders(d.orders); if(d.priceTable) setPriceTable(d.priceTable); if(d.history) setHistory(d.history); notify("ÊàêÂäü"); setShowGlobalSettings(false); }, 'danger'); }catch(x){notify("ÈåØË™§");} e.target.value=''; }; r.readAsText(f); };
            const handleExportCSV = () => { const bom="\uFEFF"; const h="Êó•Êúü,È°ßÂÆ¢,Ê©üÂè∞,Ê¨æÂºè,Êï∏Èáè,ÂñÆÂÉπ(Âè∞),Á∏ΩÈ°ç,Ê†∏Â∞ç,ÂÖ•Ë¢ã,ÈáãÂá∫‰∏≠\n"; const r=orders.map(o=>`${o.date},${o.customer},${o.productName},${o.variant},${o.qty},${o.unitPriceTWD},${o.customerTotalTWD},${o.isPurchased?'V':'X'},${o.isPicked?'V':'X'},${o.isReleasing?'Y':''}`).join("\n"); saveAs(new Blob([bom+h+r],{type:"text/csv"}),"Export.csv"); notify("CSV‰∏ãËºâ"); };
            const handleCloudUpload = async () => { if(!apiUrl)return notify("ÁÑ°API"); setIsSyncing(true); try{ await fetch(apiUrl,{method:'POST',body:JSON.stringify({orders,priceTable,history,timestamp:new Date().toISOString()})}); notify("ÂÇô‰ªΩÊàêÂäü"); }catch(e){notify("Â§±Êïó");}finally{setIsSyncing(false);} };
            const handleCloudDownload = async () => { if(!apiUrl)return notify("ÁÑ°API"); setIsSyncing(true); try{ const r=await fetch(apiUrl); const d=await r.json(); if(d.orders) triggerConfirm('ÂêåÊ≠•',`ÊôÇÈñì:${d.timestamp}`,()=>{setOrders(d.orders);if(d.priceTable)setPriceTable(d.priceTable);if(d.history)setHistory(d.history);notify("ÊàêÂäü");setShowGlobalSettings(false);},'danger'); }catch(e){notify("Â§±Êïó");}finally{setIsSyncing(false);} };
            
            const handleSaveEditedOrder = () => { 
                if(!editingOrder) return;
                if(!editingOrder.productName.trim()) return notify("Ê©üÂè∞ÂêçÁ®±‰∏çÂèØÁÇ∫Á©∫");
                if(!editingOrder.variant.trim()) return notify("Ê¨æÂºè‰∏çÂèØÁÇ∫Á©∫");

                const eco=editingOrder.ecoFeePerUnit*editingOrder.qty; 
                setOrders(p=>p.map(o=>o.id===editingOrder.id?{...editingOrder,ecoFeeTotal:eco,customerTotalTWD:(editingOrder.unitPriceTWD*editingOrder.qty)+eco,gashaTotalJPY:editingOrder.unitPriceJPY*editingOrder.qty,gashaTotalTWD:editingOrder.unitPriceTWD*editingOrder.qty}:o)); 
                setEditingOrder(null); 
                notify("Â∑≤Êõ¥Êñ∞"); 
            };
            
            const initiateStatusUpdate = (order, targetStatus) => { if (order.qty === 1) { setOrders(p => p.map(o => o.id === order.id ? { ...o, [targetStatus]: true } : o)); notify("Â∑≤Êõ¥Êñ∞"); return; } setStatusUpdateData({ order, targetStatus, maxQty: order.qty }); setStatusUpdateQty(order.qty); };
            const confirmStatusUpdate = () => { if (!statusUpdateData) return; const { order, targetStatus } = statusUpdateData; const qtyToUpdate = parseInt(statusUpdateQty); if (qtyToUpdate <= 0 || qtyToUpdate > order.qty) return; setOrders(prev => { if (qtyToUpdate === order.qty) return prev.map(o => o.id === order.id ? { ...o, [targetStatus]: true } : o); const updatedOrders = []; const ecoNew = order.ecoFeePerUnit * qtyToUpdate; updatedOrders.push({ ...order, id: Date.now(), qty: qtyToUpdate, ecoFeeTotal: ecoNew, gashaTotalJPY: order.unitPriceJPY*qtyToUpdate, gashaTotalTWD: order.unitPriceTWD*qtyToUpdate, customerTotalTWD: (order.unitPriceTWD*qtyToUpdate)+ecoNew, [targetStatus]: true }); prev.forEach(o => { if (o.id === order.id) { const leftQty = o.qty - qtyToUpdate; updatedOrders.push({ ...o, qty: leftQty, ecoFeeTotal: o.ecoFeePerUnit*leftQty, gashaTotalJPY: o.unitPriceJPY*leftQty, gashaTotalTWD: o.unitPriceTWD*leftQty, customerTotalTWD: (o.unitPriceTWD*leftQty)+(o.ecoFeePerUnit*leftQty) }); } else updatedOrders.push(o); }); return updatedOrders; }); setStatusUpdateData(null); notify(`Â∑≤Êõ¥Êñ∞ ${qtyToUpdate} ÂÄã`); };
            
            const openPriceEditor = () => { 
                let source = priceTable;
                if (!source || Object.keys(source).length === 0) {
                    source = DEFAULT_PRICE_TABLE;
                }
                const list = Object.entries(source).map(([j,t])=>({
                    id: Date.now()+Math.random(),
                    j: parseInt(j) || 0,
                    t: parseInt(t) || 0
                })).sort((a,b)=>a.j-b.j);
                
                setEditingPrices(list); 
                setShowPriceEditor(true); 
            };
            const addPriceRow = () => setEditingPrices(prev => [...prev, { id: Date.now(), j: '', t: '' }]);
            const removePriceRow = (id) => setEditingPrices(prev => prev.filter(p => p.id !== id));
            const updatePriceRow = (id, field, val) => setEditingPrices(prev => prev.map(p => p.id === id ? { ...p, [field]: val === '' ? '' : parseInt(val) } : p));
            
            const savePriceEditor = () => { 
                const t = {}; 
                editingPrices.forEach(p => { 
                    if (p.j && p.t) t[p.j] = p.t; 
                }); 
                setPriceTable(t); 
                setShowPriceEditor(false); 
                notify("ÂÉπÊ†ºÂ∑≤Êõ¥Êñ∞"); 
            };
            const handleResetPrice = () => { if(confirm("Á¢∫ÂÆöÊÅ¢Âæ©È†êË®≠ÂÉπÊ†ºË°®Ôºü")) { setPriceTable(DEFAULT_PRICE_TABLE); setShowPriceEditor(false); notify("Â∑≤ÊÅ¢Âæ©È†êË®≠"); } };

            const handleCopyOrderText = (c) => { 
                if(!c) return; 
                
                let details = "";
                c.items.forEach(i => {
                    details += `${i.productName} ${i.variant} x${i.qty} $${i.customerTotalTWD}${i.isReleasing?' (ÈáãÂá∫‰∏≠)':''}\n`;
                });

                const t = `Ë¶™ÊÑõÁöÑ ${c.name} ÊÇ®Â•ΩÔºå
ÊÇ®Êú¨Ê¨°ÁöÑÈÄ£Á∑öÊâ≠ËõãË≥ºÁâ©ÊòéÁ¥∞Â¶Ç‰∏ãÔºö
${details}
----------------
Ê∂àË≤ªÁ∏ΩÈ°çÔºö$${c.totalSpent.toLocaleString()}

ÂèØ‰ª•ÂÖàÂπ´ÊàëÊê≠Ê≥¢ÂçªÂèØ
ÊúâË™§ÁöÑË©±ÔΩûË´ãË∂ïÂø´Ë∑üÊàëË™™ÔºÅ

‚Çä‚äπ Ëã•ÊòØÊ≤íÊúâÊºèÊéâÁöÑÂïÜÂìÅ ‚Çä‚äπ
Â∞±ÂèØ‰ª•Áõ¥Êé•ÁµêÂ∏≥ÂõâÔºÅ

Á∂≤ÂùÄÔºöÔºàÈÄôË£°ÁïôÁµ¶ÊàëËá™Â∑±Ëº∏ÂÖ•Á∂≤ÂùÄÔºâ
ÊâæÂà∞Ëá™Â∑±ÂêçÂ≠óÂæåÂÆåÊàê‰∏ãÂñÆÂ∞±ÂèØ‰ª•Âöï
êôö Êî∂Âà∞ÊâÄÊúâÈÄ£ÁµêÂæåË´ãÁõ°ÈÄüÂÆåÊàê‰ªòÊ¨æ
    ‰∏çË¶ÅËÄΩË™§Âà∞ÊúÄ‰Ω≥ÁöÑË≥ûÂë≥ÊúüÈôêÂî∑

‚öù p.s. Ââç‰∏ÄÊ¨°ÈÄ£Á∑öÊúâÈñãÁÆ±ÂàÜ‰∫´ÁöÑÊúãÂèã~
‰∏ãÂñÆÂæåË´ãÂπ´ÊàëÂÇôË®ª‰∏Ä‰∏ãÔºöÈñãÁÆ±Á¶Æ
ùê≠ùê°ùêöùêßùê§ ùê≤ùê®ùêÆ (‚Äû‚Ä¢ ÷ä ‚Ä¢‚Äû)‡©≠`;

                const ta = document.createElement("textarea"); 
                ta.value = t; 
                document.body.appendChild(ta); 
                ta.select(); 
                document.execCommand('copy'); 
                document.body.removeChild(ta); 
                notify("Â∑≤Ë§áË£ΩÈÄöÁü•ÊñáÊ°à"); 
            };

            const handleExportToImage = async (c) => { 
                if(!c) return; 
                setExportTargetCustomer(c); 
                await new Promise(r=>setTimeout(r,500)); 
                const el = document.getElementById('hidden-receipt-container'); 
                if(el) { 
                    try { 
                        const cvs = await html2canvas(el,{useCORS:true,scale:2,backgroundColor:'#FCF4E9', logging: false}); 
                        saveAs(cvs.toDataURL(), `${c.name}.png`); 
                        notify("ÂúñÁâá‰∏ãËºâ"); 
                    } catch(e){ 
                        notify("Â§±Êïó"); 
                    } finally { 
                        setExportTargetCustomer(null); 
                    } 
                } 
            };

            // === ÊâπÈáèÂåØÂá∫ÈÅ∏ÂèñÂäüËÉΩ ===
            const toggleExportSelection = (name) => {
                const newSet = new Set(selectedForExport);
                if (newSet.has(name)) newSet.delete(name);
                else newSet.add(name);
                setSelectedForExport(newSet);
            };

            const toggleSelectAllExport = () => {
                if (selectedForExport.size === filteredCustomers.length) {
                    setSelectedForExport(new Set());
                } else {
                    setSelectedForExport(new Set(filteredCustomers.map(c => c.name)));
                }
            };

            const handleBatchExportImages = async () => {
                if(filteredCustomers.length === 0) return notify("ÁÑ°È°ßÂÆ¢Ë≥áÊñô");
                if(isBatchExporting) return;

                const targets = selectedForExport.size > 0 
                    ? filteredCustomers.filter(c => selectedForExport.has(c.name))
                    : filteredCustomers;

                if (targets.length === 0) return notify("Êú™ÈÅ∏Âèñ‰ªª‰ΩïÈ°ßÂÆ¢");

                setIsBatchExporting(true);
                const zip = new JSZip();
                const folder = zip.folder("receipts");

                try {
                    for (let i = 0; i < targets.length; i++) {
                        const customer = targets[i];
                        setBatchProgress(`${i + 1} / ${targets.length}`);
                        
                        setExportTargetCustomer(customer);
                        await new Promise(r => setTimeout(r, 500));
                        
                        const el = document.getElementById('hidden-receipt-container');
                        if (el) {
                            const canvas = await html2canvas(el, { useCORS: true, scale: 2, backgroundColor: '#FCF4E9', logging: false });
                            const dataUrl = canvas.toDataURL('image/png');
                            const imgData = dataUrl.replace(/^data:image\/(png|jpg);base64,/, "");
                            folder.file(`${customer.name}.png`, imgData, { base64: true });
                        }
                    }

                    setBatchProgress("ÊâìÂåÖ‰∏≠...");
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `Gasha_Receipts_${new Date().toISOString().slice(0,10)}.zip`);
                    notify("ÊâπÈáè‰∏ãËºâÂÆåÊàêÔºÅ");
                    setSelectedForExport(new Set());

                } catch (error) {
                    console.error(error);
                    notify("ÊâπÈáè‰∏ãËºâÂ§±Êïó");
                } finally {
                    setExportTargetCustomer(null);
                    setIsBatchExporting(false);
                    setBatchProgress('');
                }
            };

            return (
                <div className="min-h-screen pb-24 relative">
                    {notification && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[300] bg-latte-800 text-cream-50 px-6 py-3 rounded-2xl shadow-xl flex items-center gap-2 animate-in border border-latte-600"><CheckCircle2 size={18}/>{notification}</div>}
                    
                    <div className="bg-latte-500 text-cream-50 p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto">
                        <h1 className="text-xl font-bold flex items-center gap-2"><Zap className="fill-cream-100 text-cream-100"/> Cuibo Gasha</h1>
                        <div className="flex gap-2 items-center"><div className="text-xs bg-latte-600 px-2 py-1 rounded-lg">Live</div><button onClick={()=>setShowGlobalSettings(true)} className="p-1.5 hover:bg-latte-600 rounded-lg"><Settings size={20}/></button></div>
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm border-b border-cream-200 sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'input',l:'ÈÄ£Á∑ö',i:Plus},{id:'list',l:'Ê∏ÖÂñÆ',i:ListOrdered},{id:'customers',l:'È°ßÂÆ¢',i:Users},{id:'dashboard',l:'ÂÑÄË°®Êùø',i:LayoutDashboard}].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setSearchQuery('')}} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[11px] font-bold transition-all ${activeTab === t.id ? 'text-latte-500 border-b-2 border-latte-500 bg-cream-50' : 'text-latte-300'}`}>
                                    <div className="relative"><t.i size={20}/>{t.id === 'list' && stats.pendingPick > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border border-white"></span>}</div>{t.l}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="max-w-2xl mx-auto p-4 space-y-5">
                        {activeTab === 'input' && (
                            <div className="space-y-4 animate-in">
                                
                                {/* 1. Customer Input */}
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-cream-100 rounded-full flex items-center justify-center text-latte-400"><User size={20}/></div>
                                        <input 
                                            type="text" 
                                            list="hist-customers"
                                            placeholder="Ë™∞Ë¶ÅË≤∑? (Ëº∏ÂÖ•È°ßÂÆ¢Âêç)" 
                                            className="flex-1 bg-cream-50 rounded-xl py-3 px-4 font-bold text-lg outline-none focus:ring-2 ring-latte-300 text-latte-800"
                                            value={inputCustomer || ''}
                                            onChange={e => setInputCustomer(e.target.value)}
                                            autoComplete="off"
                                        />
                                        <datalist id="hist-customers">
                                            {history.customers.map((c, i) => <option key={`${c}-${i}`} value={c}/>)}
                                        </datalist>
                                    </div>
                                </div>

                                {/* 2. Machine Input */}
                                <div className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="text-xs font-bold text-latte-400 tracking-wider flex items-center gap-1"><Tag size={12}/> Ê©üÂè∞Ë®≠ÂÆö (ÈéñÂÆö‰∏≠)</div>
                                        <button onClick={openPriceEditor} className="text-[10px] text-latte-500 bg-cream-100 px-2 py-1 rounded border border-cream-200 flex items-center gap-1 hover:bg-cream-200 active:scale-95 transition"><Edit size={10}/> Á∑®ËºØÂÉπÊ†º</button>
                                    </div>
                                    <input 
                                        type="text"
                                        list="hist-machines"
                                        placeholder="Ëº∏ÂÖ•Ê©üÂè∞ÂêçÁ®± (‰æã: Âêâ‰ºäÂç°Âìá)" 
                                        className="w-full text-lg font-bold border-b-2 border-cream-200 focus:border-latte-400 outline-none pb-2 mb-4 placeholder-latte-300 bg-transparent text-latte-800"
                                        value={currentMachine.name || ''}
                                        onChange={e => setCurrentMachine({...currentMachine, name: e.target.value})}
                                        autoComplete="off"
                                    />
                                    <datalist id="hist-machines">
                                        {history.machines.map((m, i) => <option key={`${m}-${i}`} value={m}/>)}
                                    </datalist>

                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {Object.keys(priceTable).map(Number).sort((a,b)=>a-b).map(price => (
                                            <button 
                                                key={price}
                                                onClick={() => handlePriceSelect(price)}
                                                className={`py-2 rounded-xl text-sm font-bold transition-all ${currentMachine.priceJPY === price ? 'price-btn-active' : 'price-btn'}`}
                                            >
                                                ¬•{price}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center bg-cream-50 p-3 rounded-2xl border border-cream-200">
                                        <div className="text-xs text-latte-400 font-bold">Ëá™ÂãïÊèõÁÆó</div>
                                        <div className="font-black text-latte-600 flex items-baseline gap-1">
                                            <span className="text-sm font-normal text-latte-400">¬•{currentMachine.priceJPY} =</span>
                                            <span className="text-xl">NT${currentMachine.priceTWD}</span>
                                        </div>
                                    </div>
                                    <div className="mt-3">
                                        <input 
                                            type="text" 
                                            list="hist-variants"
                                            placeholder="Ëº∏ÂÖ•Ê¨æÂºè (ÁÑ°È†êË®≠)" 
                                            className="w-full text-sm bg-cream-50 rounded-xl p-3 outline-none text-latte-800"
                                            value={currentMachine.variant || ''}
                                            onChange={e => setCurrentMachine({...currentMachine, variant: e.target.value})}
                                            autoComplete="off"
                                        />
                                        <datalist id="hist-variants">
                                            {history.variants.map((v, i) => <option key={`${v}-${i}`} value={v}/>)}
                                        </datalist>
                                    </div>
                                </div>

                                {/* 3. Qty & Add */}
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3 bg-cream-50 rounded-full p-1 border border-cream-200">
                                            <button onClick={() => setInputQty(Math.max(1, inputQty-1))} className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-latte-400 active:scale-90 transition"><Minus size={18}/></button>
                                            <span className="text-xl font-black w-8 text-center text-latte-800">{inputQty}</span>
                                            <button onClick={() => setInputQty(inputQty+1)} className="w-10 h-10 rounded-full bg-latte-500 text-white shadow-md flex items-center justify-center active:scale-90 transition"><Plus size={18}/></button>
                                        </div>
                                        <button 
                                            onClick={() => setIsEco(!isEco)}
                                            className={`flex flex-col items-center justify-center px-4 py-2 rounded-2xl border-2 transition-all ${isEco ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300 bg-white'}`}
                                        >
                                            <span className="text-[10px] font-bold">ÊãÜÊÆº/Áí∞‰øù</span>
                                            <span className="font-bold text-sm">+{isEco ? `$${ECO_FEE*inputQty}` : '$0'}</span>
                                        </button>
                                    </div>
                                    <button onClick={addOrder} className="w-full bg-latte-800 text-cream-50 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-latte-800/20 active:scale-98 transition flex items-center justify-center gap-2 hover:brightness-110">
                                        <span>Âä†ÂÖ•Ê∏ÖÂñÆ</span>
                                        <span className="bg-white/20 px-2 py-0.5 rounded text-sm">
                                            ${(currentMachine.priceTWD * inputQty) + (isEco ? ECO_FEE * inputQty : 0)}
                                        </span>
                                    </button>
                                </div>
                                {orders.length > 0 && <div className="text-center text-xs text-latte-400 opacity-70">ÂâõÂä†ÂÖ•: {orders[0].customer} - {orders[0].productName} (${orders[0].customerTotalTWD})</div>}
                            </div>
                        )}

                        {/* 2. List Tab */}
                        {activeTab === 'list' && (
                            <div className="space-y-3 animate-in">
                                <div className="relative mb-4"><input type="text" placeholder="ÊêúÂ∞ã..." value={searchQuery || ''} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-white rounded-xl p-3 pl-10 border border-cream-200 outline-none focus:border-latte-400 text-latte-800" /><Search size={16} className="absolute left-3 top-3.5 text-latte-300" /></div>
                                {filteredOrders.map(o => (
                                    <div key={o.id} onClick={() => setEditingOrder(o)} className={`bg-white p-4 rounded-3xl shadow-soft border border-cream-200 transition-all cursor-pointer hover:border-latte-300 active:scale-[0.99] ${o.isPicked ? 'opacity-60 bg-cream-50' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div><div className="font-bold text-latte-800 text-lg">{o.customer}</div><div className="text-xs text-latte-500 font-bold">{o.productName} <span className="text-latte-300 font-normal">({o.variant})</span></div><div className="mt-1 text-xs bg-cream-100 inline-block px-2 py-0.5 rounded text-latte-600 font-bold border border-cream-200">¬•{o.unitPriceJPY} x {o.qty}{o.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1">+Áí∞‰øù</span>}</div></div>
                                            <div className="text-right"><div className="text-xl font-black text-latte-600">${o.customerTotalTWD}</div><div className="flex gap-2 justify-end mt-1"><button onClick={(e) => { e.stopPropagation(); deleteOrder(o.id); }} className="text-cream-300 p-2 hover:text-rose-400 bg-cream-50 rounded-lg active:scale-95"><Trash2 size={16}/></button></div></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3"><button onClick={(e) => { e.stopPropagation(); toggleStatus(o.id, 'isPurchased'); }} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 border ${o.isPurchased ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><CheckCircle2 size={14}/> {o.isPurchased ? 'Â∑≤Ê†∏Â∞ç' : 'ÂæÖÊ†∏Â∞ç'}</button><button onClick={(e) => { e.stopPropagation(); toggleStatus(o.id, 'isPicked'); }} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 border ${o.isPicked ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><ShoppingBag size={14}/> {o.isPicked ? 'Â∑≤ÂÖ•Ë¢ã' : 'ÂæÖÂÖ•Ë¢ã'}</button></div>
                                    </div>
                                ))}
                                {filteredOrders.length === 0 && <div className="text-center text-latte-300 py-10">Ê≤íÊúâÁ¨¶ÂêàÁöÑË®ÇÂñÆ</div>}
                            </div>
                        )}

                        {/* 3. Customers Tab */}
                        {activeTab === 'customers' && (
                            <div className="space-y-2 animate-in">
                                <div className="flex justify-between items-center px-2 mb-2">
                                    <div className="flex items-center gap-3">
                                        <button 
                                            onClick={toggleSelectAllExport}
                                            className="text-latte-400 hover:text-latte-600 active:scale-95 transition"
                                        >
                                            {filteredCustomers.length > 0 && selectedForExport.size === filteredCustomers.length ? <CheckSquare size={20}/> : <Square size={20}/>}
                                        </button>
                                        <span className="text-xs font-bold text-latte-400">ÂÖ± {filteredCustomers.length} ‰Ωç</span>
                                    </div>
                                    
                                    <button 
                                        onClick={handleBatchExportImages} 
                                        disabled={isBatchExporting || filteredCustomers.length === 0}
                                        className={`text-xs px-3 py-1.5 rounded-lg flex items-center gap-1.5 shadow-sm active:scale-95 transition disabled:opacity-50 font-bold ${selectedForExport.size > 0 ? 'bg-latte-600 text-white' : 'bg-white text-latte-600 border border-latte-200'}`}
                                    >
                                        {isBatchExporting ? <Loader2 size={12} className="animate-spin"/> : <FileArchive size={12}/>}
                                        {isBatchExporting 
                                            ? `ÊâìÂåÖ‰∏≠ ${batchProgress}` 
                                            : selectedForExport.size > 0 
                                                ? `ÂåØÂá∫ ${selectedForExport.size} ‰ΩçÈÅ∏Âèñ` 
                                                : 'ÂåØÂá∫ÂÖ®ÈÉ® (ÁõÆÂâçÊêúÂ∞ã)'}
                                    </button>
                                </div>
                                {filteredCustomers.map(c => {
                                    const isSelected = selectedForExport.has(c.name);
                                    return (
                                        <div key={c.name} onClick={(e) => { e.stopPropagation(); setSelectedCustomerName(c.name); }} className={`rounded-3xl p-5 shadow-soft border flex justify-between items-center cursor-pointer mb-2 active:scale-[0.99] transition-all relative ${isSelected ? 'bg-latte-50 border-latte-300' : 'bg-white border-cream-200 hover:border-latte-200'}`}>
                                            
                                            {/* Selection Checkbox Area */}
                                            <div 
                                                className="absolute left-0 top-0 bottom-0 w-12 flex items-center justify-center z-10"
                                                onClick={(e) => { e.stopPropagation(); toggleExportSelection(c.name); }}
                                            >
                                                {isSelected ? <CheckSquare size={20} className="text-latte-600 fill-latte-50"/> : <Square size={20} className="text-cream-300"/>}
                                            </div>

                                            <div className="flex items-center gap-4 pl-8">
                                                <div className="w-12 h-12 bg-cream-100 text-latte-600 rounded-full flex items-center justify-center font-bold border border-cream-200 text-lg shadow-sm">{c.name[0]}</div>
                                                <div><h4 className="font-bold text-latte-800 text-lg">{c.name}</h4><p className="text-xs text-latte-400">{c.orderCount} Á≠ÜË®ÇÂñÆ</p></div>
                                            </div>
                                            <div className="text-right"><p className="font-black text-latte-500 text-lg">${c.totalSpent.toLocaleString()}</p><div className="text-[10px] text-latte-300 bg-cream-50 px-2 py-0.5 rounded-lg inline-block">ÈªûÊìäÊü•Áúã</div></div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* 4. Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-3 gap-3 animate-in">
                                <div className="bg-[#D98E73] text-white p-4 rounded-2xl shadow-lg relative overflow-hidden flex flex-col justify-center items-center text-center">
                                    <div className="opacity-10 absolute"><Coins size={60}/></div>
                                    <p className="text-[10px] font-bold opacity-90 tracking-wider">Êó•Âπ£Á∏ΩÊäï</p>
                                    <p className="text-xl font-black mt-1">¬•{stats.totalJPY.toLocaleString()}</p>
                                </div>

                                <div className="bg-[#BF9E85] text-white p-4 rounded-2xl shadow-lg relative overflow-hidden flex flex-col justify-center items-center text-center">
                                    <div className="opacity-10 absolute"><DollarSign size={60}/></div>
                                    <p className="text-[10px] font-bold opacity-90 tracking-wider">È†ê‰º∞ÁáüÊî∂</p>
                                    <p className="text-xl font-black mt-1">${stats.totalRevenue.toLocaleString()}</p>
                                </div>

                                <div className="bg-[#8C7A6B] text-white p-4 rounded-2xl shadow-lg relative overflow-hidden flex flex-col justify-center items-center text-center">
                                    <div className="opacity-10 absolute"><Package size={60}/></div>
                                    <p className="text-[10px] font-bold opacity-90 tracking-wider">Á∏ΩÈ°ÜÊï∏</p>
                                    <p className="text-xl font-black mt-1">{stats.totalCount}</p>
                                </div>

                                <div className="col-span-3 bg-white p-4 rounded-3xl border border-cream-200 shadow-sm flex justify-around text-center gap-1">
                                    <button onClick={() => { setShowDashboardDetail('purchase'); setDashboardSearchQuery(''); }} className="flex-1 hover:bg-cream-50 rounded-xl transition p-2"><div className="text-3xl font-black text-latte-400">{stats.pendingPurchase}</div><div className="text-xs text-latte-300 font-bold mt-1">ÂæÖÊ†∏Â∞ç</div></button>
                                    <div className="w-px bg-cream-200"></div>
                                    <button onClick={() => { setShowDashboardDetail('pick'); setDashboardSearchQuery(''); }} className="flex-1 hover:bg-cream-50 rounded-xl transition p-2"><div className="text-3xl font-black text-latte-600">{stats.pendingPick}</div><div className="text-xs text-latte-300 font-bold mt-1">ÂæÖÂÖ•Ë¢ã</div></button>
                                    <div className="w-px bg-cream-200"></div>
                                    <button onClick={() => { setShowDashboardDetail('releasing'); setDashboardSearchQuery(''); }} className="flex-1 hover:bg-cream-50 rounded-xl transition p-2"><div className="text-3xl font-black text-amber-500">{stats.releasingCount}</div><div className="text-xs text-amber-500 font-bold mt-1">ÈáãÂá∫Ê±†</div></button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- Modals --- */}
                    
                    {/* Dashboard Detail */}
                    {showDashboardDetail && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md h-[85vh] flex flex-col shadow-2xl animate-in">
                                 <div className="flex justify-between items-center p-6 pb-2 border-b border-cream-100">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2">
                                        {showDashboardDetail === 'purchase' ? <Coins size={20}/> : showDashboardDetail === 'pick' ? <ShoppingBag size={20}/> : <Megaphone size={20}/>}
                                        {showDashboardDetail === 'purchase' ? 'ÂæÖÊ†∏Â∞çÊ∏ÖÂñÆ' : showDashboardDetail === 'pick' ? 'ÂæÖÂÖ•Ë¢ãÊ∏ÖÂñÆ' : 'ÈáãÂá∫Ê±† (Á≠âÂæÖË™çÈ†ò)'}
                                    </h3>
                                    <button onClick={() => setShowDashboardDetail(null)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>
                                
                                {showDashboardDetail !== 'releasing' && (
                                    <div className="px-4 pt-2 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2">
                                        <button onClick={() => setDashboardSearchQuery('')} className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${!dashboardSearchQuery ? 'bg-latte-500 text-white border-latte-500' : 'bg-white text-latte-400 border-cream-200'}`}>ÂÖ®ÈÉ®</button>
                                        {uniqueCustomersInDashboard.map(n => <button key={n} onClick={() => setDashboardSearchQuery(n === dashboardSearchQuery ? '' : n)} className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${n === dashboardSearchQuery ? 'bg-latte-500 text-white border-latte-500' : 'bg-white text-latte-600 border-cream-200'}`}>{n}</button>)}
                                    </div>
                                )}
                                <div className="p-4 pb-0"><div className="relative"><input type="text" placeholder="ÊêúÂ∞ã..." className="w-full bg-cream-50 border border-cream-200 p-2 pl-9 rounded-xl text-sm outline-none focus:border-latte-400 text-latte-800" value={dashboardSearchQuery || ''} onChange={e => setDashboardSearchQuery(e.target.value)}/><Search size={14} className="absolute left-3 top-2.5 text-latte-400"/></div></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {getDashboardDetailOrders().map(o => (
                                          <div key={o.id} className="bg-white p-4 rounded-2xl border border-cream-200 shadow-sm flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-latte-800">{o.productName} <span className="text-xs font-normal text-latte-400">({o.variant})</span></div>
                                                <div className="text-xs text-latte-400 mt-1">{o.customer} ¬∑ {o.qty} ÂÄã</div>
                                            </div>
                                            {showDashboardDetail === 'releasing' ? (
                                                <button onClick={()=>{setTransferringOrder(o); setTransferTarget(''); setTransferQty(o.qty);}} className="px-4 py-2 rounded-xl font-bold text-xs shadow-sm active:scale-95 transition bg-amber-500 text-white border border-amber-600 animate-pulse">Êúâ‰∫∫Ë¶Å!</button>
                                            ) : (
                                                <button onClick={() => initiateStatusUpdate(o, showDashboardDetail === 'purchase' ? 'isPurchased' : 'isPicked')} className={`px-4 py-2 rounded-xl font-bold text-xs shadow-sm active:scale-95 transition ${showDashboardDetail === 'purchase' ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-emerald-100 text-emerald-700 border border-emerald-200'}`}>{showDashboardDetail === 'purchase' ? 'Ê†∏Â∞ç' : 'ÂÖ•Ë¢ã'}</button>
                                            )}
                                         </div>
                                    ))}
                                    {getDashboardDetailOrders().length === 0 && <div className="text-center text-latte-300 py-10">Â§™Ê£í‰∫Ü!ÈÉΩË≤∑ÂÆå‰∫Ü!</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Status Update */}
                    {statusUpdateData && (
                        <div className="fixed inset-0 z-[260] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2">Á¢∫Ë™çÊï∏Èáè</h3><button onClick={()=>{setStatusUpdateData(null)}} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="bg-cream-50 p-3 rounded-xl border border-cream-200 flex justify-between items-center"><span className="text-sm font-bold text-latte-600">ÂÆåÊàêÊï∏Èáè</span><div className="flex items-center gap-3"><button onClick={()=>setStatusUpdateQty(Math.max(1, statusUpdateQty-1))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-latte-400 active:scale-90"><Minus size={14}/></button><span className="text-lg font-black w-8 text-center text-latte-800">{statusUpdateQty}</span><button onClick={()=>setStatusUpdateQty(Math.min(statusUpdateData.order.qty, statusUpdateQty+1))} className="w-8 h-8 rounded-full bg-latte-500 text-white shadow flex items-center justify-center active:scale-90"><Plus size={14}/></button></div></div>
                                <button onClick={confirmStatusUpdate} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition">Á¢∫Ë™ç</button>
                            </div>
                        </div>
                    )}

                    {/* Global Settings */}
                    {showGlobalSettings && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-5 shadow-2xl animate-in max-h-[85vh] overflow-y-auto">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Settings size={20}/> Á≥ªÁµ±Ë®≠ÂÆö</h3><button onClick={()=>setShowGlobalSettings(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="space-y-3"><h4 className="text-xs font-bold text-latte-400 uppercase">Cloud Sync</h4><input type="text" placeholder="Apps Script URL" className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl outline-none text-latte-800 text-xs focus:border-latte-400" value={apiUrl} onChange={e=>setApiUrl(e.target.value)}/><div className="grid grid-cols-2 gap-2"><button onClick={handleCloudUpload} disabled={isSyncing} className="bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">{isSyncing?<Loader2 size={18} className="animate-spin"/>:<Cloud size={18}/>}<span className="text-xs">ÂÇô‰ªΩ</span></button><button onClick={handleCloudDownload} disabled={isSyncing} className="bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-md shadow-emerald-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">{isSyncing?<Loader2 size={18} className="animate-spin"/>:<RefreshCcw size={18}/>}<span className="text-xs">ÈÇÑÂéü</span></button></div></div>
                                <div className="space-y-3 pt-2 border-t border-cream-100"><h4 className="text-xs font-bold text-latte-400 uppercase">Ë≥áÊñôÁÆ°ÁêÜ</h4><button onClick={handleExportCSV} className="w-full bg-white border border-latte-200 text-latte-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95 transition"><FileSpreadsheet size={18} className="text-green-600"/> ÂåØÂá∫ CSV</button><div className="grid grid-cols-2 gap-2"><button onClick={handleExportBackup} className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition"><FileJson size={16}/> ÂÇô‰ªΩ</button><label className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition cursor-pointer"><Upload size={16}/> ÈÇÑÂéü<input type="file" className="hidden" ref={fileInputRef} onChange={handleImportBackup} accept=".json"/></label></div>
                                <button onClick={handleClearHistory} className="w-full bg-latte-100 text-latte-600 py-3 rounded-xl font-bold mt-2 flex items-center justify-center gap-2 active:scale-95 transition hover:bg-latte-200"><History size={18}/> Ê∏ÖÈô§Ê≠∑Âè≤Á¥ÄÈåÑ</button>
                                <button onClick={handleClearAllData} className="w-full bg-rose-50 border border-rose-100 text-rose-500 py-3 rounded-xl font-bold mt-2 flex items-center justify-center gap-2 active:scale-95 transition hover:bg-rose-100"><Trash2 size={18}/> Ê∏ÖÈô§ÊâÄÊúâË®ÇÂñÆ</button></div>
                            </div>
                        </div>
                    )}

                    {/* Price Editor */}
                    {showPriceEditor && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-4 shadow-2xl animate-in max-h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> ÂÉπÊ†ºË°®</h3><button onClick={()=>setShowPriceEditor(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-2 p-1">{editingPrices.map(p => (<div key={p.id} className="flex gap-2 items-center"><input type="number" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-800 outline-none" value={p.j === 0 ? 0 : (p.j || '')} onChange={e=>{setEditingPrices(pre=>pre.map(x=>x.id===p.id?{...x,j:e.target.value === '' ? '' : parseInt(e.target.value)}:x))}}/><ArrowRight size={14} className="text-latte-300"/><input type="number" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-600 outline-none" value={p.t === 0 ? 0 : (p.t || '')} onChange={e=>{setEditingPrices(pre=>pre.map(x=>x.id===p.id?{...x,t:e.target.value === '' ? '' : parseInt(e.target.value)}:x))}}/><button onClick={()=>{setEditingPrices(pre=>pre.filter(x=>x.id!==p.id))}} className="w-8 h-8 flex items-center justify-center text-cream-300 hover:text-rose-500"><Trash2 size={16}/></button></div>))}<div className="flex gap-2"><button onClick={handleResetPrice} className="flex-1 py-3 border border-dashed border-rose-300 bg-rose-50 text-rose-500 rounded-xl text-sm font-bold flex items-center justify-center gap-1"><RotateCcw size={16}/> ÊÅ¢Âæ©È†êË®≠</button><button onClick={addPriceRow} className="flex-1 py-3 border border-dashed border-latte-300 rounded-xl text-latte-400 text-sm font-bold flex items-center justify-center gap-1"><Plus size={16}/> Êñ∞Â¢û</button></div></div>
                                <button onClick={savePriceEditor} className="w-full bg-latte-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">ÂÑ≤Â≠ò</button>
                            </div>
                        </div>
                    )}

                    {/* Customer Detail (Live Data) */}
                    {activeCustomerDetail && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[160] flex items-end md:items-center justify-center p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl">
                                <div className="p-6 border-b border-cream-200 flex justify-between items-start bg-cream-50 rounded-t-[30px] md:rounded-t-3xl">
                                    <div><h3 className="text-xl font-bold text-latte-800 flex items-center gap-2"><User size={20}/> {activeCustomerDetail.name}</h3><div className="text-xs text-latte-500 font-bold mt-2 bg-white px-2 py-1 rounded-lg border border-cream-200 inline-block shadow-sm">Á∏ΩÈ°ç: ${activeCustomerDetail.totalSpent.toLocaleString()}</div></div>
                                    <div className="flex gap-2"><button onClick={()=>handleCopyOrderText(activeCustomerDetail)} className="p-2.5 bg-white border border-cream-200 rounded-xl active:scale-95" title="ÊñáÊ°à"><ClipboardList size={18}/></button><button onClick={()=>handleExportToImage(activeCustomerDetail)} className="p-2.5 bg-white border border-cream-200 rounded-xl active:scale-95" title="Â≠òÂúñ"><ImageIcon size={18}/></button><button onClick={()=>setSelectedCustomerName(null)} className="p-2.5 bg-cream-200 text-latte-600 rounded-xl active:scale-95"><X size={18}/></button></div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {activeCustomerDetail.items.map((item)=>(
                                        <div key={item.id} className={`flex justify-between items-center p-4 border rounded-2xl shadow-sm transition-all cursor-pointer ${item.isReleasing ? 'bg-amber-50 border-amber-200' : 'bg-white border-cream-200 hover:border-latte-300 active:scale-[0.99]'}`} onClick={(e)=>{e.stopPropagation(); setEditingOrder(item);}}>
                                            <div>
                                                <div className="font-bold text-sm text-latte-800">{item.productName}</div>
                                                <div className="text-xs text-latte-400 mt-1 font-bold">{item.variant} {item.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1">(Âê´Áí∞‰øù)</span>} {item.isReleasing && <span className="text-amber-600 ml-1">üì¢ ÈáãÂá∫‰∏≠</span>}</div>
                                            </div>
                                            <div className="text-right flex items-center gap-2">
                                                <div>
                                                    <div className="text-xs text-latte-400 mb-1">x {item.qty}</div>
                                                    <div className="text-sm text-latte-600 font-black">${item.customerTotalTWD}</div>
                                                </div>
                                                {!item.isReleasing ? (
                                                    <button onClick={(e)=>{e.stopPropagation(); setReleasingOrder(item); setReleaseQty(1);}} className="p-2 bg-cream-100 text-latte-500 rounded-lg border border-cream-200 hover:bg-amber-100 hover:text-amber-600 transition"><Megaphone size={16}/></button>
                                                ) : (
                                                    <button onClick={(e)=>{e.stopPropagation(); handleCancelRelease(item.id)}} className="p-2 bg-amber-100 text-amber-600 rounded-lg border border-amber-200 hover:bg-cream-100 transition"><Undo2 size={16}/></button>
                                                )}
                                                <button onClick={(e)=>{e.stopPropagation(); setTransferringOrder(item); setTransferTarget(''); setTransferQty(1);}} className="p-2 bg-cream-100 text-latte-500 rounded-lg border border-cream-200 hover:bg-latte-200 transition"><ArrowRightCircle size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Release Confirm Modal */}
                    {releasingOrder && (
                        <div className="fixed inset-0 z-[260] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Megaphone size={20}/> Á¢∫Ë™çÈáãÂá∫</h3>
                                    <button onClick={()=>{setReleasingOrder(null)}} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>
                                <div className="space-y-3">
                                    <p className="text-sm text-latte-600">Â∞áÂïÜÂìÅÊ®ôË®òÁÇ∫„ÄåÈáãÂá∫‰∏≠„ÄçÔºåÁ≠âÂæÖË™çÈ†ò„ÄÇ<br/><span className="text-xs text-latte-400">*Â∏≥Âãô‰ªçÊéõÂú®ÂéüÈ°ßÂÆ¢Âêç‰∏ãÔºåÁõ¥Âà∞ËΩâËÆìÊàêÂäü„ÄÇ</span></p>
                                    <div className="bg-cream-50 p-3 rounded-xl border border-cream-200 flex justify-between items-center"><span className="text-sm font-bold text-latte-600">Êï∏Èáè</span><div className="flex items-center gap-3"><button onClick={()=>setReleaseQty(Math.max(1, releaseQty-1))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-latte-400 active:scale-90" disabled={releaseQty<=1}><Minus size={14}/></button><span className="text-lg font-black w-8 text-center text-latte-800">{releaseQty}</span><button onClick={()=>setReleaseQty(Math.min(releasingOrder.qty, releaseQty+1))} className="w-8 h-8 rounded-full bg-latte-500 text-white shadow flex items-center justify-center active:scale-90" disabled={releaseQty>=releasingOrder.qty}><Plus size={14}/></button></div></div>
                                </div>
                                <button onClick={handleMarkAsReleasing} className="w-full bg-amber-500 text-white py-3.5 rounded-2xl font-bold shadow-lg active:scale-95 transition">Á¢∫Ë™çÊ®ôË®ò</button>
                            </div>
                        </div>
                    )}

                    {/* Transfer Modal */}
                    {transferringOrder && (
                        <div className="fixed inset-0 z-[260] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><ArrowRightCircle size={20}/> {transferringOrder.isReleasing ? 'Ë™çÈ†ò (ËΩâËÆì)' : 'ËΩâËÆìË®ÇÂñÆ'}</h3><button onClick={()=>{setTransferringOrder(null)}} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="space-y-3">
                                    <div><p className="text-sm text-latte-500 mb-1">ÂïÜÂìÅÔºö<strong>{transferringOrder.productName}</strong></p><p className="text-xs text-latte-400">ÊåÅÊúâÔºö{transferringOrder.qty} ÂÄã</p></div>
                                    <div className="bg-cream-50 p-3 rounded-xl border border-cream-200 flex justify-between items-center"><span className="text-sm font-bold text-latte-600">Êï∏Èáè</span><div className="flex items-center gap-3"><button onClick={()=>setTransferQty(Math.max(1, transferQty-1))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-latte-400 active:scale-90" disabled={transferQty<=1}><Minus size={14}/></button><span className="text-lg font-black w-8 text-center text-latte-800">{transferQty}</span><button onClick={()=>setTransferQty(Math.min(transferringOrder.qty, transferQty+1))} className="w-8 h-8 rounded-full bg-latte-500 text-white shadow flex items-center justify-center active:scale-90" disabled={transferQty>=transferringOrder.qty}><Plus size={14}/></button></div></div>
                                    <div><p className="text-sm text-latte-500 mb-2">Â∞çË±°Ôºö</p><input list="cl_trans" className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl outline-none font-bold text-latte-800" value={transferTarget || ''} onChange={e => setTransferTarget(e.target.value)} placeholder="Ëº∏ÂÖ•Êñ∞È°ßÂÆ¢ÂêçÁ®±" list="hist-customers" autoComplete="off"/><datalist id="cl_trans">{history.customers.map((c,i)=><option key={`${c}-${i}`} value={c}/>)}</datalist></div>
                                </div>
                                <button onClick={handleTransferOrder} disabled={!transferTarget} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg active:scale-95 transition disabled:opacity-50">Á¢∫Ë™çËΩâËÆì</button>
                            </div>
                        </div>
                    )}

                    {/* App Confirm */}
                    {confirmConfig && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl space-y-4 border border-cream-200">
                                <h3 className={`font-bold text-xl flex items-center gap-2 ${confirmConfig.type === 'danger' ? 'text-rose-500' : 'text-latte-800'}`}>{confirmConfig.type === 'danger' && <AlertCircle size={24}/>}{confirmConfig.title}</h3>
                                <p className="text-latte-600 text-sm whitespace-pre-line leading-relaxed font-medium">{confirmConfig.message}</p>
                                <div className="flex gap-3 pt-2"><button onClick={() => setConfirmConfig(null)} className="flex-1 py-3.5 rounded-2xl font-bold bg-cream-100 text-latte-500 hover:bg-cream-200 active:scale-95 transition-all">ÂèñÊ∂à</button><button onClick={() => { confirmConfig.onConfirm(); setConfirmConfig(null); }} className={`flex-1 py-3.5 rounded-2xl font-bold text-white shadow-lg active:scale-95 transition-all flex justify-center items-center gap-1 ${confirmConfig.type === 'danger' ? 'bg-rose-500 hover:bg-rose-600' : 'bg-latte-500 hover:bg-latte-600'}`}>Á¢∫Ë™ç</button></div>
                            </div>
                        </div>
                    )}

                    {/* Order Edit Modal */}
                    {editingOrder && (
                        <div className="fixed inset-0 z-[250] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> Á∑®ËºØË®ÇÂñÆ</h3>
                                    <button onClick={()=>setEditingOrder(null)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>
                                
                                {editingOrder.isReleasing ? (
                                    <div className="space-y-4 py-4 text-center">
                                        <div className="w-16 h-16 bg-cream-100 rounded-full flex items-center justify-center mx-auto text-latte-400">
                                            <AlertCircle size={32}/>
                                        </div>
                                        <h4 className="font-bold text-lg text-latte-800">Ê≠§ÁÇ∫ÈáãÂá∫ÂçÄÂïÜÂìÅ</h4>
                                        <p className="text-sm text-latte-500">
                                            ÈáãÂá∫ÂçÄÂïÜÂìÅÁÇ∫Êö´Â≠òÁãÄÊÖãÔºå‰∏çÂèØÁõ¥Êé•‰øÆÊîπÂÖßÂÆπ„ÄÇ<br/>
                                            Ë´ãÂÖàÂ∞áÂïÜÂìÅ <strong>ËΩâËÆì</strong> Áµ¶Á¢∫Ë™çË™çÈ†òÁöÑÈ°ßÂÆ¢Ôºå<br/>ÂÜçÈÄ≤Ë°åË¶èÊ†º‰øÆÊîπ„ÄÇ
                                        </p>
                                        <button 
                                            onClick={() => {
                                                setTransferringOrder(editingOrder);
                                                setTransferQty(editingOrder.qty); 
                                                setEditingOrder(null);
                                            }}
                                            className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition flex items-center justify-center gap-2"
                                        >
                                            <ArrowRightCircle size={18}/> Á´ãÂç≥ËΩâËÆì
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="space-y-3 overflow-y-auto max-h-[60vh] p-1">
                                            <div>
                                                <label className="text-xs font-bold text-latte-400 ml-1">È°ßÂÆ¢ÂêçÁ®± (ÂîØËÆÄ)</label>
                                                <div className="w-full bg-cream-50 p-3 rounded-xl font-bold text-latte-600">{editingOrder.customer}</div>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-latte-400 ml-1">Ê©üÂè∞ÂêçÁ®±</label>
                                                <input 
                                                    list="hist-machines" 
                                                    className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none focus:border-latte-400 font-bold text-latte-800" 
                                                    value={editingOrder.productName || ''} 
                                                    onChange={e=>setEditingOrder({...editingOrder, productName: e.target.value})}
                                                    autoComplete="off"
                                                />
                                            </div>
                                            
                                            <label className="text-xs font-bold text-latte-400 ml-1">ÂñÆÂÉπË™øÊï¥ (Ëá™ÂãïÊèõÁÆó)</label>
                                            <div className="grid grid-cols-4 gap-2 mb-2">
                                                {Object.keys(priceTable).map(Number).sort((a,b)=>a-b).map(price => (
                                                    <button 
                                                        key={price}
                                                        onClick={() => setEditingOrder({
                                                            ...editingOrder, 
                                                            unitPriceJPY: price,
                                                            unitPriceTWD: priceTable[price] || 0
                                                        })}
                                                        className={`py-2 rounded-xl text-sm font-bold transition-all ${editingOrder.unitPriceJPY === price ? 'price-btn-active' : 'price-btn'}`}
                                                    >
                                                        ¬•{price}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="flex justify-between items-center bg-cream-50 p-3 rounded-2xl border border-cream-200 mb-3">
                                                <div className="text-xs text-latte-400 font-bold">Ëá™ÂãïÊèõÁÆó</div>
                                                <div className="font-black text-latte-600 flex items-baseline gap-1">
                                                    <span className="text-sm font-normal text-latte-400">¬•{editingOrder.unitPriceJPY} =</span>
                                                    <span className="text-xl">NT${editingOrder.unitPriceTWD}</span>
                                                </div>
                                            </div>

                                            <div className="flex gap-2">
                                                <div className="flex-1">
                                                    <label className="text-xs font-bold text-latte-400 ml-1">Ê¨æÂºè</label>
                                                    <input 
                                                        list="hist-variants" 
                                                        className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none focus:border-latte-400 font-bold text-latte-800" 
                                                        value={editingOrder.variant || ''} 
                                                        onChange={e=>setEditingOrder({...editingOrder, variant: e.target.value})}
                                                        autoComplete="off"
                                                    />
                                                </div>
                                                <div className="w-24">
                                                    <label className="text-xs font-bold text-latte-400 ml-1">Êï∏Èáè</label>
                                                    <div className="flex items-center bg-white border border-cream-200 rounded-xl p-1">
                                                        <button onClick={()=>setEditingOrder({...editingOrder, qty: Math.max(1, editingOrder.qty-1)})} className="w-8 h-8 flex items-center justify-center text-latte-400 active:scale-90"><Minus size={14}/></button>
                                                        <span className="flex-1 text-center font-bold text-latte-800">{editingOrder.qty}</span>
                                                        <button onClick={()=>setEditingOrder({...editingOrder, qty: editingOrder.qty+1})} className="w-8 h-8 flex items-center justify-center text-latte-400 active:scale-90"><Plus size={14}/></button>
                                                    </div>
                                                </div>
                                            </div>

                                            <button onClick={()=>setEditingOrder({...editingOrder, ecoFeePerUnit: editingOrder.ecoFeePerUnit > 0 ? 0 : ECO_FEE})} className={`w-full py-3 rounded-xl border-2 font-bold transition-all flex items-center justify-center gap-2 ${editingOrder.ecoFeePerUnit > 0 ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300'}`}>
                                                <span className="text-xs">Áí∞‰øùË≤ªÁãÄÊÖã:</span>
                                                {editingOrder.ecoFeePerUnit > 0 ? 'Â∑≤ÂïüÁî® (+10)' : 'Êú™ÂïüÁî®'}
                                            </button>
                                        </div>
                                        <button onClick={handleSaveEditedOrder} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition">ÂÑ≤Â≠òËÆäÊõ¥</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Hidden Receipt (for Image Generation) */}
                    {exportTargetCustomer && (
                        <div id="hidden-receipt-container">
                            <div className="receipt-card">
                                <div className="receipt-header"><div className="receipt-title">{exportTargetCustomer.name} Ê∏ÖÂñÆ</div><div className="receipt-subtitle">{new Date().toLocaleString()}</div></div>
                                <table className="receipt-table">
                                    <thead><tr><th style={{textAlign:'left'}}>ÂïÜÂìÅ</th><th style={{textAlign:'right'}}>ÂñÆÂÉπ</th><th style={{textAlign:'center'}}>Êï∏</th><th style={{textAlign:'right'}}>Â∞èË®à</th></tr></thead>
                                    <tbody>{exportTargetCustomer.items.map((i,x)=><tr key={x}><td>{i.productName} {i.variant}</td><td style={{textAlign:'right'}}>{i.unitPriceTWD}</td><td style={{textAlign:'center'}}>{i.qty}</td><td style={{textAlign:'right'}}>{i.customerTotalTWD}</td></tr>)}</tbody>
                                </table>
                                <div className="receipt-summary">Á∏ΩÈ°ç: ${exportTargetCustomer.totalSpent.toLocaleString()}</div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


