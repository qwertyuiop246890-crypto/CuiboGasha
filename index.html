<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuibo Gasha WMS Pro</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 載入外部套件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- 4. 設定自定義顏色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: { 50: '#FFFBF5', 100: '#FCF4E9', 200: '#EBE0D6', 300: '#D3C5BC' },
                        latte: { 400: '#B5A496', 500: '#957E6B', 600: '#8C6A5D', 800: '#5E4B41', 900: '#4A3B32' }
                    },
                    boxShadow: { 'soft': '0 4px 20px -5px rgba(149, 126, 107, 0.1)' },
                    animation: { 'in': 'fadeIn 0.2s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.98)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FCF4E9; color: #5E4B41; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 隱藏匯出區塊 */
        #hidden-receipt-container { position: fixed; top: 0; left: -9999px; width: 500px; background-color: #FCF4E9; z-index: -100; padding: 40px; }
        .receipt-card { background: #fff; padding: 30px; border-radius: 20px; border: 1px solid #EBE0D6; }
        .receipt-header { text-align: center; border-bottom: 2px dashed #D3C5BC; padding-bottom: 20px; margin-bottom: 20px; }
        .receipt-title { font-size: 24px; font-weight: 900; color: #5E4B41; }
        .receipt-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: 700; color: #8C6A5D; }
        .receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .receipt-table th { text-align: left; padding-bottom: 8px; border-bottom: 1px solid #EBE0D6; color: #957E6B; font-size: 12px; }
        .receipt-table td { padding: 10px 0; border-bottom: 1px dashed #EBE0D6; vertical-align: top; }
        .receipt-summary { background: #FFFBF5; padding: 20px; border-radius: 12px; text-align: right; border: 1px solid #EBE0D6; font-weight: 900; color: #957E6B; font-size: 20px; }
        .receipt-footer { margin-top: 30px; text-align: center; font-size: 12px; color: #B5A496; font-weight: bold; }
        
        .price-btn-active { background-color: #957E6B; color: #FFFBF5; border-color: #957E6B; }
        .price-btn { background-color: #FFFBF5; color: #B5A496; border: 1px solid #EBE0D6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, ShoppingBag, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Truck, DollarSign, Search, X, ChevronRight, ClipboardList, 
            User, ListOrdered, Tag, CheckSquare, Trash2, Edit, Save, 
            Image as ImageIcon, Download, Loader2, Coins, Circle, ShoppingCart, Settings,
            Cloud, Upload, FileJson, FileSpreadsheet, RefreshCcw, Minus, ArrowRightCircle
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            // 1. 設定
            const DEFAULT_PRICE_TABLE = { 100: 50, 200: 80, 300: 120, 400: 140, 500: 170, 600: 190, 800: 260, 1000: 360, 1500: 450 };
            const ECO_FEE = 10; 
            const RELEASE_ZONE_NAME = "釋出區";

            // 2. 狀態
            const loadLocal = (key, def) => { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; };
            const [orders, setOrders] = useState(() => loadLocal('cuibo_gasha_orders', []));
            const [priceTable, setPriceTable] = useState(() => loadLocal('cuibo_gasha_pricetable', DEFAULT_PRICE_TABLE));
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem('cuibo_gasha_api_url') || '');

            const [currentMachine, setCurrentMachine] = useState({ name: '', priceJPY: 500, priceTWD: 170, variant: '' });
            const [inputCustomer, setInputCustomer] = useState('');
            const [inputQty, setInputQty] = useState(1);
            const [isEco, setIsEco] = useState(false);

            const [activeTab, setActiveTab] = useState('input'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCustomerName, setSelectedCustomerName] = useState(null); // 改為存 Name，確保資料即時性
            const [notification, setNotification] = useState(null);
            const [exportTargetCustomer, setExportTargetCustomer] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            
            const [showPriceEditor, setShowPriceEditor] = useState(false);
            const [editingPrices, setEditingPrices] = useState([]);
            const [showGlobalSettings, setShowGlobalSettings] = useState(false);
            
            const [showDashboardDetail, setShowDashboardDetail] = useState(null); 
            const [dashboardSearchQuery, setDashboardSearchQuery] = useState(''); 
            const [statusUpdateData, setStatusUpdateData] = useState(null); 
            const [statusUpdateQty, setStatusUpdateQty] = useState(1);

            const [editingOrder, setEditingOrder] = useState(null); 
            const [transferringOrder, setTransferringOrder] = useState(null); 
            const [transferTarget, setTransferTarget] = useState(''); 
            const [transferQty, setTransferQty] = useState(1);
            
            const [confirmConfig, setConfirmConfig] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('cuibo_gasha_orders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_pricetable', JSON.stringify(priceTable)); }, [priceTable]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_api_url', apiUrl); }, [apiUrl]);

            // 3. 邏輯計算
            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
            const triggerConfirm = (title, message, onConfirm, type = 'info') => { setConfirmConfig({ title, message, onConfirm, type }); };

            const customerList = useMemo(() => {
                const map = {};
                orders.forEach(o => {
                    const cleanName = o.customer ? o.customer.trim() : 'Unknown';
                    if (!map[cleanName]) map[cleanName] = { name: cleanName, totalSpent: 0, items: [], orderCount: 0 };
                    map[cleanName].orderCount += 1;
                    map[cleanName].totalSpent += o.customerTotalTWD;
                    map[cleanName].items.push({ ...o, itemTotal: o.customerTotalTWD, finalPrice: o.unitPriceTWD });
                });
                return Object.values(map).sort((a,b) => b.totalSpent - a.totalSpent);
            }, [orders]);

            // 為了讓 Modal 資料即時連動，我們不存整個物件，只存 Name，然後即時查找
            const activeCustomerDetail = useMemo(() => {
                if (!selectedCustomerName) return null;
                return customerList.find(c => c.name === selectedCustomerName) || { name: selectedCustomerName, totalSpent: 0, items: [] };
            }, [customerList, selectedCustomerName]);

            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));
            const filteredOrders = orders.filter(o => o.customer.includes(searchQuery) || o.productName.includes(searchQuery) || (o.variant && o.variant.includes(searchQuery)));
            
            const stats = useMemo(() => {
                const totalRevenue = orders.reduce((acc, o) => acc + o.customerTotalTWD, 0);
                const totalJPY = orders.reduce((acc, o) => acc + o.gashaTotalJPY, 0);
                const totalCount = orders.reduce((acc, o) => acc + o.qty, 0);
                const pendingPurchase = orders.filter(o => !o.isPurchased).reduce((acc, o) => acc + o.qty, 0);
                const pendingPick = orders.filter(o => o.isPurchased && !o.isPicked).reduce((acc, o) => acc + o.qty, 0);
                return { totalRevenue, totalJPY, totalCount, pendingPurchase, pendingPick };
            }, [orders]);

            const getDashboardDetailOrders = () => {
                let list = [];
                if (showDashboardDetail === 'purchase') list = orders.filter(o => !o.isPurchased);
                else if (showDashboardDetail === 'pick') list = orders.filter(o => o.isPurchased && !o.isPicked);
                if (dashboardSearchQuery) list = list.filter(o => o.customer.includes(dashboardSearchQuery));
                return list.sort((a, b) => a.productName.localeCompare(b.productName));
            };

            const uniqueCustomersInDashboard = useMemo(() => {
                let list = [];
                if (showDashboardDetail === 'purchase') list = orders.filter(o => !o.isPurchased);
                else if (showDashboardDetail === 'pick') list = orders.filter(o => o.isPurchased && !o.isPicked);
                return [...new Set(list.map(o => o.customer))].sort();
            }, [orders, showDashboardDetail]);

            // 4. 操作 Handlers
            const handlePriceSelect = (jpy) => setCurrentMachine(p => ({ ...p, priceJPY: jpy, priceTWD: priceTable[jpy] || 0 }));
            
            const addOrder = () => {
                if (!currentMachine.name) return notify("請輸入機台名稱");
                if (!inputCustomer) return notify("請輸入顧客名稱");
                const unitPriceTWD = currentMachine.priceTWD;
                const ecoTotal = isEco ? (ECO_FEE * inputQty) : 0;
                const newOrder = {
                    id: Date.now(), date: new Date().toISOString().split('T')[0],
                    customer: inputCustomer.trim(), productName: currentMachine.name, variant: currentMachine.variant || '隨機', qty: inputQty,
                    unitPriceJPY: currentMachine.priceJPY, unitPriceTWD: unitPriceTWD,
                    ecoFeePerUnit: isEco ? ECO_FEE : 0, ecoFeeTotal: ecoTotal,
                    gashaTotalJPY: currentMachine.priceJPY * inputQty, gashaTotalTWD: unitPriceTWD * inputQty, customerTotalTWD: (unitPriceTWD * inputQty) + ecoTotal,
                    isPurchased: false, isPicked: false
                };
                setOrders(p => [newOrder, ...p]);
                setInputCustomer(''); setInputQty(1); notify(`已加入: ${newOrder.customer}`);
            };

            const toggleStatus = (id, field) => setOrders(p => p.map(o => o.id === id ? { ...o, [field]: !o[field] } : o));
            const deleteOrder = (id) => triggerConfirm('刪除', '確定刪除此訂單？', () => { setOrders(p => p.filter(o => o.id !== id)); notify("已刪除"); }, 'danger');
            
            const initiateStatusUpdate = (order, targetStatus) => {
                if (order.qty === 1) { setOrders(p => p.map(o => o.id === order.id ? { ...o, [targetStatus]: true } : o)); notify("狀態已更新"); return; }
                setStatusUpdateData({ order, targetStatus, maxQty: order.qty }); setStatusUpdateQty(order.qty);
            };
            const confirmStatusUpdate = () => {
                if (!statusUpdateData) return;
                const { order, targetStatus } = statusUpdateData;
                const qtyToUpdate = parseInt(statusUpdateQty);
                if (qtyToUpdate <= 0 || qtyToUpdate > order.qty) return;
                setOrders(prev => {
                    if (qtyToUpdate === order.qty) return prev.map(o => o.id === order.id ? { ...o, [targetStatus]: true } : o);
                    const updatedOrders = [];
                    const ecoNew = order.ecoFeePerUnit * qtyToUpdate;
                    updatedOrders.push({ ...order, id: Date.now(), qty: qtyToUpdate, ecoFeeTotal: ecoNew, gashaTotalJPY: order.unitPriceJPY*qtyToUpdate, gashaTotalTWD: order.unitPriceTWD*qtyToUpdate, customerTotalTWD: (order.unitPriceTWD*qtyToUpdate)+ecoNew, [targetStatus]: true });
                    prev.forEach(o => {
                        if (o.id === order.id) {
                            const leftQty = o.qty - qtyToUpdate;
                            updatedOrders.push({ ...o, qty: leftQty, ecoFeeTotal: o.ecoFeePerUnit*leftQty, gashaTotalJPY: o.unitPriceJPY*leftQty, gashaTotalTWD: o.unitPriceTWD*leftQty, customerTotalTWD: (o.unitPriceTWD*leftQty)+(o.ecoFeePerUnit*leftQty) });
                        } else updatedOrders.push(o);
                    });
                    return updatedOrders;
                });
                setStatusUpdateData(null); notify(`已更新 ${qtyToUpdate} 個`);
            };

            const handleTransferOrder = () => {
                if (!transferringOrder || !transferTarget) return;
                const target = transferTarget.trim();
                const qty = parseInt(transferQty);
                if (qty <= 0 || qty > transferringOrder.qty) return notify("數量錯誤");
                
                triggerConfirm('確認轉讓', `將 ${qty} 個轉讓給「${target}」？`, () => {
                    setOrders(prev => {
                        if (qty === transferringOrder.qty) return prev.map(o => o.id === transferringOrder.id ? { ...o, customer: target } : o);
                        const updated = [];
                        const ecoNew = transferringOrder.ecoFeePerUnit * qty;
                        updated.push({ ...transferringOrder, id: Date.now(), customer: target, qty: qty, ecoFeeTotal: ecoNew, gashaTotalJPY: transferringOrder.unitPriceJPY*qty, gashaTotalTWD: transferringOrder.unitPriceTWD*qty, customerTotalTWD: (transferringOrder.unitPriceTWD*qty)+ecoNew });
                        prev.forEach(o => {
                            if (o.id === transferringOrder.id) {
                                const left = o.qty - qty;
                                updated.push({ ...o, qty: left, ecoFeeTotal: o.ecoFeePerUnit*left, gashaTotalJPY: o.unitPriceJPY*left, gashaTotalTWD: o.unitPriceTWD*left, customerTotalTWD: (o.unitPriceTWD*left)+(o.ecoFeePerUnit*left) });
                            } else updated.push(o);
                        });
                        return updated;
                    });
                    setTransferringOrder(null); setTransferTarget(''); notify(`已轉讓給 ${target}`);
                });
            };

            const handleSaveEditedOrder = () => {
                if (!editingOrder) return;
                const eco = editingOrder.ecoFeePerUnit * editingOrder.qty;
                setOrders(p => p.map(o => o.id === editingOrder.id ? { ...editingOrder, ecoFeeTotal: eco, customerTotalTWD: (editingOrder.unitPriceTWD*editingOrder.qty)+eco, gashaTotalJPY: editingOrder.unitPriceJPY*editingOrder.qty, gashaTotalTWD: editingOrder.unitPriceTWD*editingOrder.qty } : o));
                setEditingOrder(null); notify("訂單已更新");
            };

            // Cloud & Backup
            const handleCloudUpload = async () => {
                if(!apiUrl) return notify("請先設定 API"); setIsSyncing(true);
                try { await fetch(apiUrl, { method: 'POST', body: JSON.stringify({ orders, priceTable, timestamp: new Date().toISOString() }) }); notify("備份成功"); } catch(e) { notify("上傳失敗"); } finally { setIsSyncing(false); }
            };
            const handleCloudDownload = async () => {
                if(!apiUrl) return notify("請先設定 API"); setIsSyncing(true);
                try {
                    const res = await fetch(apiUrl); const data = await res.json();
                    if(data.orders && confirm(`雲端時間: ${data.timestamp}\n覆蓋資料？`)) { setOrders(data.orders); if(data.priceTable) setPriceTable(data.priceTable); notify("同步成功"); setShowGlobalSettings(false); }
                } catch(e) { notify("下載失敗"); } finally { setIsSyncing(false); }
            };
            const handleExportCSV = () => {
                const bom = "\uFEFF"; const h = "日期,顧客,機台,款式,數量,單價(日),單價(台),環保費,總額,投幣,撿貨\n";
                const r = orders.map(o => `${o.date},${o.customer},${o.productName},${o.variant},${o.qty},${o.unitPriceJPY},${o.unitPriceTWD},${o.ecoFeeTotal},${o.customerTotalTWD},${o.isPurchased?'V':'X'},${o.isPicked?'V':'X'}`).join("\n");
                saveAs(new Blob([bom+h+r], {type:"text/csv;charset=utf-8"}), `Gasha_${new Date().toISOString().slice(0,10)}.csv`); notify("CSV已下載");
            };

            // Helpers
            const handleCopyText = (c) => {
                if(!c) return;
                let t = `親愛的 ${c.name} 您好，\n明細如下：\n`;
                c.items.forEach(i => t+=`${i.productName} ${i.variant} x${i.qty} $${i.customerTotalTWD}\n`);
                t+=`------------\n總額：$${c.totalSpent.toLocaleString()}\n請確認無誤後匯款，謝謝！`;
                const ta = document.createElement("textarea"); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); notify("已複製文案");
            };
            const handleGenImage = async (c) => {
                if(!c) return; setExportTargetCustomer(c); await new Promise(r=>setTimeout(r,100));
                const el = document.getElementById('hidden-receipt-container');
                if(el) { try { const cvs = await html2canvas(el,{useCORS:true,scale:2,backgroundColor:'#FCF4E9'}); saveAs(cvs.toDataURL(), `${c.name}.png`); notify("圖片已下載"); } catch(e){ notify("失敗"); } finally { setExportTargetCustomer(null); } }
            };

            return (
                <div className="min-h-screen pb-24 relative">
                    {/* Components */}
                    {notification && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[300] bg-latte-800 text-cream-50 px-6 py-3 rounded-2xl shadow-xl flex items-center gap-2 animate-in border border-latte-600"><CheckCircle2 size={18}/>{notification}</div>}
                    
                    <div className="bg-latte-500 text-cream-50 p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto">
                        <h1 className="text-xl font-bold flex items-center gap-2"><Zap className="fill-cream-100 text-cream-100"/> Cuibo Gasha</h1>
                        <div className="flex gap-2 items-center"><div className="text-xs bg-latte-600 px-2 py-1 rounded-lg">Live</div><button onClick={()=>setShowGlobalSettings(true)} className="p-1.5 hover:bg-latte-600 rounded-lg"><Settings size={20}/></button></div>
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm border-b border-cream-200 sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'input',l:'連線',i:Plus},{id:'list',l:'清單',i:ListOrdered},{id:'customers',l:'顧客',i:Users},{id:'dashboard',l:'儀表板',i:LayoutDashboard}].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setSearchQuery('')}} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[11px] font-bold transition-all ${activeTab === t.id ? 'text-latte-500 border-b-2 border-latte-500 bg-cream-50' : 'text-latte-300'}`}>
                                    <div className="relative"><t.i size={20}/>{t.id === 'list' && stats.pendingPick > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border border-white"></span>}</div>{t.l}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="max-w-2xl mx-auto p-4 space-y-5">
                        {activeTab === 'input' && (
                            <div className="space-y-4 animate-in">
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center gap-3"><div className="w-10 h-10 bg-cream-100 rounded-full flex items-center justify-center text-latte-400"><User size={20}/></div><input type="text" placeholder="誰要買? (輸入顧客名)" className="flex-1 bg-cream-50 rounded-xl py-3 px-4 font-bold text-lg outline-none focus:ring-2 ring-latte-300 text-latte-800" value={inputCustomer} onChange={e => setInputCustomer(e.target.value)}/></div>
                                </div>
                                <div className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200">
                                    <div className="flex justify-between items-center mb-2"><div className="text-xs font-bold text-latte-400 tracking-wider flex items-center gap-1"><Tag size={12}/> 機台設定 (鎖定中)</div><button onClick={()=>{setEditingPrices(Object.entries(priceTable).map(([j,t])=>({id:Date.now()+Math.random(),j:parseInt(j),t:parseInt(t)})).sort((a,b)=>a.j-b.j)); setShowPriceEditor(true);}} className="text-[10px] text-latte-500 bg-cream-100 px-2 py-1 rounded border border-cream-200"><Edit size={10}/> 編輯價格</button></div>
                                    <input type="text" placeholder="輸入機台名稱 (例: 吉伊卡哇)" className="w-full text-lg font-bold border-b-2 border-cream-200 focus:border-latte-400 outline-none pb-2 mb-4 placeholder-latte-300 bg-transparent text-latte-800" value={currentMachine.name} onChange={e => setCurrentMachine({...currentMachine, name: e.target.value})}/>
                                    <div className="grid grid-cols-4 gap-2 mb-4">{Object.keys(priceTable).map(Number).sort((a,b)=>a-b).map(p => (<button key={p} onClick={() => handlePriceSelect(p)} className={`py-2 rounded-xl text-sm font-bold transition-all ${currentMachine.priceJPY === p ? 'price-btn-active' : 'price-btn'}`}>¥{p}</button>))}</div>
                                    <div className="flex justify-between items-center bg-cream-50 p-3 rounded-2xl border border-cream-200"><div className="text-xs text-latte-400 font-bold">自動換算</div><div className="font-black text-latte-600 flex items-baseline gap-1"><span className="text-sm font-normal text-latte-400">¥{currentMachine.priceJPY} =</span><span className="text-xl">NT${currentMachine.priceTWD}</span></div></div>
                                    <div className="mt-3"><input type="text" placeholder="款式 (預設隨機)" className="w-full text-sm bg-cream-50 rounded-xl p-3 outline-none text-latte-800" value={currentMachine.variant} onChange={e => setCurrentMachine({...currentMachine, variant: e.target.value})}/></div>
                                </div>
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3 bg-cream-50 rounded-full p-1 border border-cream-200">
                                            <button onClick={() => setInputQty(Math.max(1, inputQty-1))} className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-latte-400 active:scale-90"><Minus size={18}/></button><span className="text-xl font-black w-8 text-center text-latte-800">{inputQty}</span><button onClick={() => setInputQty(inputQty+1)} className="w-10 h-10 rounded-full bg-latte-500 text-white shadow-md flex items-center justify-center active:scale-90"><Plus size={18}/></button>
                                        </div>
                                        <button onClick={() => setIsEco(!isEco)} className={`flex flex-col items-center justify-center px-4 py-2 rounded-2xl border-2 transition-all ${isEco ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300 bg-white'}`}><span className="text-[10px] font-bold">拆殼/環保</span><span className="font-bold text-sm">+{isEco ? `$${ECO_FEE*inputQty}` : '$0'}</span></button>
                                    </div>
                                    <button onClick={addOrder} className="w-full bg-latte-800 text-cream-50 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-latte-800/20 active:scale-98 transition flex items-center justify-center gap-2 hover:brightness-110"><span>加入清單</span><span className="bg-white/20 px-2 py-0.5 rounded text-sm">${(currentMachine.priceTWD * inputQty) + (isEco ? ECO_FEE * inputQty : 0)}</span></button>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'list' && (
                            <div className="space-y-3 animate-in">
                                <div className="relative mb-4"><input type="text" placeholder="搜尋..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-white rounded-xl p-3 pl-10 border border-cream-200 outline-none focus:border-latte-400 text-latte-800" /><Search size={16} className="absolute left-3 top-3.5 text-latte-300" /></div>
                                {filteredOrders.map(o => (
                                    <div key={o.id} className={`bg-white p-4 rounded-3xl shadow-soft border border-cream-200 transition-all ${o.isPicked ? 'opacity-60 bg-cream-50' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div><div className="font-bold text-latte-800 text-lg">{o.customer}</div><div className="text-xs text-latte-500 font-bold">{o.productName} <span className="text-latte-300 font-normal">({o.variant})</span></div><div className="mt-1 text-xs bg-cream-100 inline-block px-2 py-0.5 rounded text-latte-600 font-bold border border-cream-200">¥{o.unitPriceJPY} x {o.qty}{o.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1">+環保</span>}</div></div>
                                            <div className="text-right"><div className="text-xl font-black text-latte-600">${o.customerTotalTWD}</div><div className="flex gap-2 justify-end mt-1"><button onClick={() => setEditingOrder(o)} className="text-latte-400 p-2 hover:text-latte-600 bg-cream-50 rounded-lg active:scale-95"><Edit size={16}/></button><button onClick={() => deleteOrder(o.id)} className="text-cream-300 p-2 hover:text-rose-400 bg-cream-50 rounded-lg active:scale-95"><Trash2 size={16}/></button></div></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3"><button onClick={() => toggleStatus(o.id, 'isPurchased')} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 border ${o.isPurchased ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><Coins size={14}/> {o.isPurchased ? '已投幣' : '未投幣'}</button><button onClick={() => toggleStatus(o.id, 'isPicked')} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 border ${o.isPicked ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><ShoppingBag size={14}/> {o.isPicked ? '已撿貨' : '未撿貨'}</button></div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'customers' && (
                            <div className="space-y-2 animate-in">
                                <div className="flex justify-between items-center px-2 mb-2"><span className="text-xs font-bold text-latte-400">共 {filteredCustomers.length} 位顧客</span></div>
                                {filteredCustomers.map(c => (
                                    <div key={c.name} onClick={(e) => { e.stopPropagation(); setSelectedCustomerName(c.name); }} className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200 flex justify-between items-center cursor-pointer mb-2 active:scale-[0.99] transition-all hover:border-latte-200">
                                        <div className="flex items-center gap-4"><div className="w-12 h-12 bg-cream-100 text-latte-600 rounded-full flex items-center justify-center font-bold border border-cream-200 text-lg shadow-sm">{c.name[0]}</div><div><h4 className="font-bold text-latte-800 text-lg">{c.name}</h4><p className="text-xs text-latte-400">{c.orderCount} 筆訂單</p></div></div>
                                        <div className="text-right"><p className="font-black text-latte-500 text-lg">${c.totalSpent.toLocaleString()}</p><div className="text-[10px] text-latte-300 bg-cream-50 px-2 py-0.5 rounded-lg inline-block">點擊查看</div></div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-4 animate-in">
                                <div className="bg-[#D98E73] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Coins size={80}/></div><p className="text-xs font-bold opacity-90 tracking-wider">日幣總投</p><p className="text-3xl font-black mt-2">¥{stats.totalJPY.toLocaleString()}</p><p className="text-xs opacity-70 mt-1">共 {stats.totalCount} 顆</p></div>
                                <div className="bg-[#BF9E85] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><DollarSign size={80}/></div><p className="text-xs font-bold opacity-90 tracking-wider">預估營收</p><p className="text-3xl font-black mt-2">${stats.totalRevenue.toLocaleString()}</p></div>
                                <div className="col-span-2 bg-white p-6 rounded-3xl border border-cream-200 shadow-sm flex justify-around text-center">
                                    <button onClick={() => { setShowDashboardDetail('purchase'); setDashboardSearchQuery(''); }} className="flex-1 hover:bg-cream-50 rounded-xl transition p-2"><div className="text-3xl font-black text-latte-400">{stats.pendingPurchase}</div><div className="text-xs text-latte-300 font-bold mt-1">未投幣 (查看)</div></button>
                                    <div className="w-px bg-cream-200"></div>
                                    <button onClick={() => { setShowDashboardDetail('pick'); setDashboardSearchQuery(''); }} className="flex-1 hover:bg-cream-50 rounded-xl transition p-2"><div className="text-3xl font-black text-latte-600">{stats.pendingPick}</div><div className="text-xs text-latte-300 font-bold mt-1">待撿貨 (查看)</div></button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- Modals --- */}
                    
                    {/* Dashboard Detail */}
                    {showDashboardDetail && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md h-[85vh] flex flex-col shadow-2xl animate-in">
                                 <div className="flex justify-between items-center p-6 pb-2 border-b border-cream-100">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2">{showDashboardDetail === 'purchase' ? <Coins size={20}/> : <ShoppingBag size={20}/>}{showDashboardDetail === 'purchase' ? '待投幣' : '待撿貨'}</h3><button onClick={() => setShowDashboardDetail(null)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>
                                <div className="px-4 pt-2 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2">
                                    <button onClick={() => setDashboardSearchQuery('')} className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${!dashboardSearchQuery ? 'bg-latte-500 text-white border-latte-500' : 'bg-white text-latte-400 border-cream-200'}`}>全部</button>
                                    {uniqueCustomersInDashboard.map(n => <button key={n} onClick={() => setDashboardSearchQuery(n === dashboardSearchQuery ? '' : n)} className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${n === dashboardSearchQuery ? 'bg-latte-500 text-white border-latte-500' : 'bg-white text-latte-600 border-cream-200'}`}>{n}</button>)}
                                </div>
                                <div className="p-4 pb-0"><div className="relative"><input type="text" placeholder="搜尋..." className="w-full bg-cream-50 border border-cream-200 p-2 pl-9 rounded-xl text-sm outline-none focus:border-latte-400 text-latte-800" value={dashboardSearchQuery} onChange={e => setDashboardSearchQuery(e.target.value)}/><Search size={14} className="absolute left-3 top-2.5 text-latte-400"/></div></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {getDashboardDetailOrders().map(o => (
                                         <div key={o.id} className="bg-white p-4 rounded-2xl border border-cream-200 shadow-sm flex justify-between items-center">
                                            <div><div className="font-bold text-latte-800">{o.productName} <span className="text-xs font-normal text-latte-400">({o.variant})</span></div><div className="text-xs text-latte-400 mt-1">{o.customer} · {o.qty} 個</div></div>
                                            <button onClick={() => initiateStatusUpdate(o, showDashboardDetail === 'purchase' ? 'isPurchased' : 'isPicked')} className={`px-4 py-2 rounded-xl font-bold text-xs shadow-sm active:scale-95 transition ${showDashboardDetail === 'purchase' ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-emerald-100 text-emerald-700 border border-emerald-200'}`}>{showDashboardDetail === 'purchase' ? '投幣' : '撿貨'}</button>
                                         </div>
                                    ))}
                                    {getDashboardDetailOrders().length === 0 && <div className="text-center text-latte-300 py-10">Empty</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Status Update (Qty Split) */}
                    {statusUpdateData && (
                        <div className="fixed inset-0 z-[260] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2">確認數量</h3><button onClick={()=>{setStatusUpdateData(null)}} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="bg-cream-50 p-3 rounded-xl border border-cream-200 flex justify-between items-center"><span className="text-sm font-bold text-latte-600">完成數量</span><div className="flex items-center gap-3"><button onClick={()=>setStatusUpdateQty(Math.max(1, statusUpdateQty-1))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-latte-400 active:scale-90"><Minus size={14}/></button><span className="text-lg font-black w-8 text-center text-latte-800">{statusUpdateQty}</span><button onClick={()=>setStatusUpdateQty(Math.min(statusUpdateData.order.qty, statusUpdateQty+1))} className="w-8 h-8 rounded-full bg-latte-500 text-white shadow flex items-center justify-center active:scale-90"><Plus size={14}/></button></div></div>
                                <button onClick={confirmStatusUpdate} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition">確認</button>
                            </div>
                        </div>
                    )}

                    {/* Settings */}
                    {showGlobalSettings && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-5 shadow-2xl animate-in max-h-[85vh] overflow-y-auto">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Settings size={20}/> 設定</h3><button onClick={()=>setShowGlobalSettings(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="space-y-3"><h4 className="text-xs font-bold text-latte-400 uppercase">Google Apps Script API</h4><input type="text" placeholder="URL..." className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl outline-none text-latte-800 text-xs focus:border-latte-400" value={apiUrl} onChange={e=>setApiUrl(e.target.value)}/><div className="grid grid-cols-2 gap-2"><button onClick={handleCloudUpload} disabled={isSyncing} className="bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">{isSyncing?<Loader2 size={18} className="animate-spin"/>:<Cloud size={18}/>}<span className="text-xs">備份</span></button><button onClick={handleCloudDownload} disabled={isSyncing} className="bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-md shadow-emerald-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">{isSyncing?<Loader2 size={18} className="animate-spin"/>:<RefreshCcw size={18}/>}<span className="text-xs">還原</span></button></div></div>
                                <div className="space-y-3 pt-2 border-t border-cream-100"><h4 className="text-xs font-bold text-latte-400 uppercase">資料管理</h4><button onClick={handleExportCSV} className="w-full bg-white border border-latte-200 text-latte-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95 transition"><FileSpreadsheet size={18} className="text-green-600"/> 匯出 CSV</button><div className="grid grid-cols-2 gap-2"><button onClick={handleExportBackup} className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition"><FileJson size={16}/> 備份</button><label className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition cursor-pointer"><Upload size={16}/> 還原<input type="file" className="hidden" ref={fileInputRef} onChange={handleImportBackup} accept=".json"/></label></div><button onClick={()=>{triggerConfirm('清除','確定清除所有資料？',()=>{setOrders([]);setShowGlobalSettings(false);notify("已清除");},'danger')}} className="w-full bg-rose-50 border border-rose-100 text-rose-500 py-3 rounded-xl font-bold mt-2 flex items-center justify-center gap-2 active:scale-95 transition hover:bg-rose-100"><Trash2 size={18}/> 清除所有資料</button></div>
                            </div>
                        </div>
                    )}

                    {/* Price Editor */}
                    {showPriceEditor && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-4 shadow-2xl animate-in max-h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> 價格表</h3><button onClick={()=>setShowPriceEditor(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-2 p-1">{editingPrices.map(p => (<div key={p.id} className="flex gap-2 items-center"><input type="number" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-800 outline-none" value={p.jpy} onChange={e=>{setEditingPrices(pre=>pre.map(x=>x.id===p.id?{...x,jpy:e.target.value}:x))}}/><ArrowRight size={14} className="text-latte-300"/><input type="number" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-600 outline-none" value={p.twd} onChange={e=>{setEditingPrices(pre=>pre.map(x=>x.id===p.id?{...x,twd:e.target.value}:x))}}/><button onClick={()=>{setEditingPrices(pre=>pre.filter(x=>x.id!==p.id))}} className="w-8 h-8 flex items-center justify-center text-cream-300 hover:text-rose-500"><Trash2 size={16}/></button></div>))}<button onClick={()=>{setEditingPrices(p=>[...p,{id:Date.now(),jpy:'',twd:''}])}} className="w-full py-3 border border-dashed border-latte-300 rounded-xl text-latte-400 text-sm font-bold flex items-center justify-center gap-1"><Plus size={16}/> 新增</button></div>
                                <button onClick={()=>{const t={};editingPrices.forEach(x=>{if(x.jpy&&x.twd)t[x.jpy]=x.twd});setPriceTable(t);setShowPriceEditor(false);notify("已更新");}} className="w-full bg-latte-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">儲存</button>
                            </div>
                        </div>
                    )}

                    {/* Customer Detail (Live Data) */}
                    {activeCustomerDetail && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[160] flex items-end md:items-center justify-center p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl">
                                <div className="p-6 border-b border-cream-200 flex justify-between items-start bg-cream-50 rounded-t-[30px] md:rounded-t-3xl">
                                    <div><h3 className="text-xl font-bold text-latte-800 flex items-center gap-2"><User size={20}/> {activeCustomerDetail.name}</h3><div className="text-xs text-latte-500 font-bold mt-2 bg-white px-2 py-1 rounded-lg border border-cream-200 inline-block shadow-sm">總額: ${activeCustomerDetail.totalSpent.toLocaleString()}</div></div>
                                    <div className="flex gap-2"><button onClick={()=>handleCopyOrderText(activeCustomerDetail)} className="p-2.5 bg-white border border-cream-200 rounded-xl active:scale-95" title="文案"><ClipboardList size={18}/></button><button onClick={()=>handleGenImage(activeCustomerDetail)} className="p-2.5 bg-white border border-cream-200 rounded-xl active:scale-95" title="存圖"><ImageIcon size={18}/></button><button onClick={()=>setSelectedCustomerName(null)} className="p-2.5 bg-cream-200 text-latte-600 rounded-xl active:scale-95"><X size={18}/></button></div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {activeCustomerDetail.items.map((item)=>(
                                        <div key={item.id} className="flex justify-between items-center p-4 bg-white border border-cream-200 rounded-2xl shadow-sm">
                                            <div><div className="font-bold text-sm text-latte-800">{item.productName}</div><div className="text-xs text-latte-400 mt-1 font-bold">{item.variant} {item.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1">(含環保)</span>}</div></div>
                                            <div className="text-right">
                                                <div className="text-xs text-latte-400 mb-1">x {item.qty}</div><div className="text-sm text-latte-600 font-black">${item.customerTotalTWD}</div>
                                                <button onClick={(e)=>{e.stopPropagation(); setTransferringOrder(item); setTransferTarget(''); setTransferQty(1);}} className="mt-1 text-[10px] bg-cream-100 text-latte-500 px-2 py-1 rounded border border-cream-200 flex items-center gap-1 hover:bg-cream-200 transition"><ArrowRightCircle size={10}/> 轉讓</button>
                                            </div>
                                        </div>
                                    ))}
                                    {activeCustomerDetail.items.length===0 && <div className="text-center text-latte-300 py-10">無商品</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Transfer */}
                    {transferringOrder && (
                        <div className="fixed inset-0 z-[260] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><ArrowRightCircle size={20}/> 轉讓</h3><button onClick={()=>{setTransferringOrder(null)}} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="space-y-3">
                                    <div><p className="text-sm text-latte-500 mb-1">商品：<strong>{transferringOrder.productName}</strong></p><p className="text-xs text-latte-400">持有：{transferringOrder.qty} 個</p></div>
                                    <div className="bg-cream-50 p-3 rounded-xl border border-cream-200 flex justify-between items-center"><span className="text-sm font-bold text-latte-600">數量</span><div className="flex items-center gap-3"><button onClick={()=>setTransferQty(Math.max(1, transferQty-1))} className="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-latte-400 active:scale-90" disabled={transferQty<=1}><Minus size={14}/></button><span className="text-lg font-black w-8 text-center text-latte-800">{transferQty}</span><button onClick={()=>setTransferQty(Math.min(transferringOrder.qty, transferQty+1))} className="w-8 h-8 rounded-full bg-latte-500 text-white shadow flex items-center justify-center active:scale-90" disabled={transferQty>=transferringOrder.qty}><Plus size={14}/></button></div></div>
                                    <div><p className="text-sm text-latte-500 mb-2">對象：</p><input list="cl_trans" className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl outline-none font-bold text-latte-800" value={transferTarget} onChange={e => setTransferTarget(e.target.value)}/><datalist id="cl_trans"><option value={RELEASE_ZONE_NAME}/>{filteredCustomers.map(c=><option key={c.name} value={c.name}/>)}</datalist><button onClick={()=>setTransferTarget(RELEASE_ZONE_NAME)} className="mt-2 text-xs bg-cream-100 text-latte-500 px-3 py-1 rounded-full border border-cream-200">快速選擇: {RELEASE_ZONE_NAME}</button></div>
                                </div>
                                <button onClick={handleTransferOrder} disabled={!transferTarget} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg active:scale-95 transition disabled:opacity-50">確認</button>
                            </div>
                        </div>
                    )}

                    {/* Edit Order */}
                    {editingOrder && (
                        <div className="fixed inset-0 z-[250] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> 編輯</h3><button onClick={()=>setEditingOrder(null)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                {editingOrder.customer === RELEASE_ZONE_NAME ? (
                                    <div className="space-y-4 py-4 text-center">
                                        <div className="w-16 h-16 bg-cream-100 rounded-full flex items-center justify-center mx-auto text-latte-400"><AlertCircle size={32}/></div><h4 className="font-bold text-lg text-latte-800">釋出區商品</h4><p className="text-sm text-latte-500">不可直接修改，請先轉讓給顧客。</p>
                                        <button onClick={() => { setTransferringOrder(editingOrder); setTransferQty(editingOrder.qty); setEditingOrder(null); }} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2"><ArrowRightCircle size={18}/> 立即轉讓</button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="space-y-3 overflow-y-auto max-h-[60vh] p-1">
                                            <div><label className="text-xs font-bold text-latte-400 ml-1">顧客</label><div className="w-full bg-cream-50 p-3 rounded-xl font-bold text-latte-600">{editingOrder.customer}</div></div>
                                            <div><label className="text-xs font-bold text-latte-400 ml-1">機台</label><input className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none font-bold text-latte-800" value={editingOrder.productName} onChange={e=>setEditingOrder({...editingOrder, productName: e.target.value})}/></div>
                                            <div className="flex gap-2"><div className="flex-1"><label className="text-xs font-bold text-latte-400 ml-1">款式</label><input className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none font-bold text-latte-800" value={editingOrder.variant} onChange={e=>setEditingOrder({...editingOrder, variant: e.target.value})}/></div><div className="w-24"><label className="text-xs font-bold text-latte-400 ml-1">數量</label><div className="flex items-center bg-white border border-cream-200 rounded-xl p-1"><button onClick={()=>setEditingOrder({...editingOrder, qty: Math.max(1, editingOrder.qty-1)})} className="w-8 h-8 flex items-center justify-center text-latte-400 active:scale-90"><Minus size={14}/></button><span className="flex-1 text-center font-bold text-latte-800">{editingOrder.qty}</span><button onClick={()=>setEditingOrder({...editingOrder, qty: editingOrder.qty+1})} className="w-8 h-8 flex items-center justify-center text-latte-400 active:scale-90"><Plus size={14}/></button></div></div></div>
                                            <div><label className="text-xs font-bold text-latte-400 ml-1">單價</label><input type="number" className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none font-bold text-latte-800" value={editingOrder.unitPriceTWD} onChange={e=>setEditingOrder({...editingOrder, unitPriceTWD: parseInt(e.target.value)||0})}/></div>
                                            <button onClick={()=>setEditingOrder({...editingOrder, ecoFeePerUnit: editingOrder.ecoFeePerUnit > 0 ? 0 : ECO_FEE})} className={`w-full py-3 rounded-xl border-2 font-bold transition-all ${editingOrder.ecoFeePerUnit > 0 ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300'}`}>環保費: {editingOrder.ecoFeePerUnit > 0 ? '已啟用' : '未啟用'}</button>
                                        </div>
                                        <button onClick={handleSaveEditedOrder} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg active:scale-95 transition">儲存</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {/* App Confirm */}
                    {confirmConfig && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl space-y-4 border border-cream-200">
                                <h3 className={`font-bold text-xl flex items-center gap-2 ${confirmConfig.type === 'danger' ? 'text-rose-500' : 'text-latte-800'}`}>{confirmConfig.type === 'danger' && <AlertCircle size={24}/>}{confirmConfig.title}</h3>
                                <p className="text-latte-600 text-sm whitespace-pre-line leading-relaxed font-medium">{confirmConfig.message}</p>
                                <div className="flex gap-3 pt-2"><button onClick={() => setConfirmConfig(null)} className="flex-1 py-3.5 rounded-2xl font-bold bg-cream-100 text-latte-500 hover:bg-cream-200 active:scale-95 transition-all">取消</button><button onClick={() => { confirmConfig.onConfirm(); setConfirmConfig(null); }} className={`flex-1 py-3.5 rounded-2xl font-bold text-white shadow-lg active:scale-95 transition-all flex justify-center items-center gap-1 ${confirmConfig.type === 'danger' ? 'bg-rose-500 hover:bg-rose-600' : 'bg-latte-500 hover:bg-latte-600'}`}>確認</button></div>
                            </div>
                        </div>
                    )}

                    {/* Hidden Receipt */}
                    {exportTargetCustomer && (
                        <div id="hidden-receipt-container">
                            <div className="receipt-card">
                                <div className="receipt-header"><div className="receipt-title">{exportTargetCustomer.name} 清單</div><div className="receipt-subtitle">{new Date().toLocaleString()}</div></div>
                                <table className="receipt-table">
                                    <thead><tr><th style={{textAlign:'left'}}>商品</th><th style={{textAlign:'right'}}>單價</th><th style={{textAlign:'center'}}>數</th><th style={{textAlign:'right'}}>小計</th></tr></thead>
                                    <tbody>{exportTargetCustomer.items.map((i,x)=><tr key={x}><td>{i.productName} {i.variant}</td><td style={{textAlign:'right'}}>{i.unitPriceTWD}</td><td style={{textAlign:'center'}}>{i.qty}</td><td style={{textAlign:'right'}}>{i.customerTotalTWD}</td></tr>)}</tbody>
                                </table>
                                <div className="receipt-summary">總額: ${exportTargetCustomer.totalSpent.toLocaleString()}</div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

