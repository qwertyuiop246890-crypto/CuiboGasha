<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuibo Gasha WMS Pro</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. è¼‰å…¥å¤–éƒ¨å¥—ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- 4. è¨­å®šè‡ªå®šç¾©é¡è‰² (Tailwind Config) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: {
                            50: '#FFFBF5',  // è¼¸å…¥æ¡†/æ¥µæ·ºåº•
                            100: '#FCF4E9', // å…¨åŸŸä¸»èƒŒæ™¯
                            200: '#EBE0D6', // é‚Šæ¡†/åˆ†éš”ç·š
                            300: '#D3C5BC', // å¤±æ•ˆæ–‡å­—
                        },
                        latte: {
                            400: '#B5A496', // è¼”åŠ©æ–‡å­—
                            500: '#957E6B', // ä¸»å¼·èª¿è‰² (Brand Color)
                            600: '#8C6A5D', // æ·±ä¸€é»çš„å¼·èª¿
                            800: '#5E4B41', // ä¸»è¦æ–‡å­— (æ·±å’–å•¡)
                            900: '#4A3B32', // æ¥µæ·±è‰²
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -5px rgba(149, 126, 107, 0.1)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                    },
                    animation: {
                        'in': 'fadeIn 0.3s ease-out forwards',
                        'bounce-sm': 'bounceSmall 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        bounceSmall: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.95)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* å…¨åŸŸæ¨£å¼è¨­å®š */
        body {
            background-color: #FCF4E9; /* ä¸»è‰²èª¿ */
            color: #5E4B41; /* ä¸»è¦æ–‡å­—é¡è‰² */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§ */
            -webkit-font-smoothing: antialiased;
        }

        /* éš±è—å·è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç§»é™¤é»æ“Šé«˜äº® */
        * { -webkit-tap-highlight-color: transparent; }

        /* --- åœ–ç‰‡åŒ¯å‡ºå°ˆç”¨æ¨£å¼ (éš±è—å€å¡Š) --- */
        #hidden-receipt-container {
            position: fixed;
            top: 0;
            left: -9999px;
            width: 500px;
            background-color: #FCF4E9;
            z-index: -100;
            padding: 40px;
            box-sizing: border-box;
            font-family: sans-serif;
            color: #5E4B41;
            line-height: 1.5;
        }
        
        .receipt-card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(149, 126, 107, 0.15);
            border: 1px solid #EBE0D6;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #D3C5BC;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .receipt-title { font-size: 24px; font-weight: 900; margin-bottom: 5px; color: #5E4B41; letter-spacing: 1px; }
        .receipt-subtitle { font-size: 14px; color: #957E6B; }
        
        .receipt-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 700;
            color: #8C6A5D;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .receipt-table th { text-align: left; font-size: 12px; color: #957E6B; padding-bottom: 8px; border-bottom: 1px solid #EBE0D6; }
        .receipt-table td { padding: 12px 0; border-bottom: 1px dashed #EBE0D6; vertical-align: top; }
        .receipt-table .col-total { text-align: right; }
        .receipt-table .col-price { text-align: right; padding-right: 10px; }
        .receipt-table .col-qty { text-align: center; }
        
        .item-name { font-size: 14px; font-weight: 700; color: #5E4B41; display: block; margin-bottom: 2px; }
        .item-spec { font-size: 12px; color: #B5A496; }
        .item-eco { font-size: 10px; color: #10B981; background: #ECFDF5; padding: 2px 4px; border-radius: 4px; margin-left: 4px; }
        
        .receipt-summary {
            background-color: #FFFBF5;
            padding: 20px;
            border-radius: 12px;
            text-align: right;
            border: 1px solid #EBE0D6;
        }
        .summary-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; color: #957E6B; margin-top: 10px; border-top: 1px solid #EBE0D6; padding-top: 10px; }
        
        .receipt-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #B5A496;
            font-weight: bold;
        }

        /* åƒ¹æ ¼æŒ‰éˆ•æ¨£å¼ */
        .price-btn-active { background-color: #957E6B; color: #FFFBF5; border-color: #957E6B; box-shadow: 0 4px 6px -1px rgba(149, 126, 107, 0.4); }
        .price-btn { background-color: #FFFBF5; color: #B5A496; border: 1px solid #EBE0D6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, ShoppingBag, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Truck, DollarSign, Search, X, ChevronRight, ClipboardList, 
            User, ListOrdered, Tag, CheckSquare, Trash2, Edit, Save, 
            Image as ImageIcon, Download, Loader2, Coins, Circle, ShoppingCart, Settings,
            Cloud, Upload, FileJson, FileSpreadsheet, RefreshCcw, Minus
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            // --- 1. æ ¸å¿ƒè¨­å®š ---
            const DEFAULT_PRICE_TABLE = {
                100: 50, 200: 80, 300: 120, 400: 140, 
                500: 170, 600: 190, 800: 260, 1000: 360, 1500: 450
            };
            const ECO_FEE = 10; 

            // --- 2. ç‹€æ…‹ç®¡ç† ---
            const loadLocal = (key, def) => {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : def;
            };

            const [orders, setOrders] = useState(() => loadLocal('cuibo_gasha_orders', []));
            const [priceTable, setPriceTable] = useState(() => loadLocal('cuibo_gasha_pricetable', DEFAULT_PRICE_TABLE));
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem('cuibo_gasha_api_url') || '');

            // è¼¸å…¥å€æš«å­˜
            const [currentMachine, setCurrentMachine] = useState({ name: '', priceJPY: 500, priceTWD: 170, variant: '' });
            const [inputCustomer, setInputCustomer] = useState('');
            const [inputQty, setInputQty] = useState(1);
            const [isEco, setIsEco] = useState(false);

            // UI ç‹€æ…‹
            const [activeTab, setActiveTab] = useState('input'); 
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            const [notification, setNotification] = useState(null);
            const [exportTargetCustomer, setExportTargetCustomer] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            
            // ç·¨è¼¯å™¨ç‹€æ…‹
            const [showPriceEditor, setShowPriceEditor] = useState(false);
            const [editingPrices, setEditingPrices] = useState([]);
            const [showGlobalSettings, setShowGlobalSettings] = useState(false);
            
            // è¨‚å–®ç·¨è¼¯ (æ–°åŠŸèƒ½)
            const [editingOrder, setEditingOrder] = useState(null); // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„è¨‚å–®ç‰©ä»¶
            
            // App é¢¨æ ¼ç¢ºèªå°è©±æ¡†ç‹€æ…‹
            const [confirmConfig, setConfirmConfig] = useState(null);

            const fileInputRef = useRef(null);

            // æŒä¹…åŒ–
            useEffect(() => { localStorage.setItem('cuibo_gasha_orders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_pricetable', JSON.stringify(priceTable)); }, [priceTable]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_api_url', apiUrl); }, [apiUrl]);

            // --- 3. é‚è¼¯è¨ˆç®— ---
            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const triggerConfirm = (title, message, onConfirm, type = 'info') => {
                setConfirmConfig({ title, message, onConfirm, type });
            };

            const customerList = useMemo(() => {
                const map = {};
                orders.forEach(o => {
                    const cleanName = o.customer ? o.customer.trim() : 'Unknown';
                    if (!map[cleanName]) {
                        map[cleanName] = { name: cleanName, totalSpent: 0, items: [], orderCount: 0 };
                    }
                    map[cleanName].orderCount += 1;
                    map[cleanName].totalSpent += o.customerTotalTWD;
                    map[cleanName].items.push({
                        ...o,
                        itemTotal: o.customerTotalTWD,
                        finalPrice: o.unitPriceTWD
                    });
                });
                return Object.values(map).sort((a,b) => b.totalSpent - a.totalSpent);
            }, [orders]);

            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));

            const stats = useMemo(() => {
                const totalRevenue = orders.reduce((acc, o) => acc + o.customerTotalTWD, 0);
                const totalJPY = orders.reduce((acc, o) => acc + o.gashaTotalJPY, 0);
                const totalCount = orders.reduce((acc, o) => acc + o.qty, 0);
                const pendingPurchase = orders.filter(o => !o.isPurchased).reduce((acc, o) => acc + o.qty, 0);
                const pendingPick = orders.filter(o => o.isPurchased && !o.isPicked).reduce((acc, o) => acc + o.qty, 0);
                return { totalRevenue, totalJPY, totalCount, pendingPurchase, pendingPick };
            }, [orders]);

            const filteredOrders = orders.filter(o => 
                o.customer.includes(searchQuery) || 
                o.productName.includes(searchQuery) || 
                (o.variant && o.variant.includes(searchQuery))
            );

            // --- 4. æ“ä½œè™•ç† ---
            const handlePriceSelect = (jpy) => {
                const twd = priceTable[jpy] || 0;
                setCurrentMachine(prev => ({ ...prev, priceJPY: jpy, priceTWD: twd }));
            };

            // åƒ¹æ ¼ç·¨è¼¯å™¨
            const openPriceEditor = () => {
                const list = Object.entries(priceTable).map(([jpy, twd]) => ({ id: Date.now() + Math.random(), jpy: parseInt(jpy), twd: parseInt(twd) }));
                list.sort((a,b) => a.jpy - b.jpy);
                setEditingPrices(list);
                setShowPriceEditor(true);
            };
            const addPriceRow = () => setEditingPrices(prev => [...prev, { id: Date.now(), jpy: '', twd: '' }]);
            const removePriceRow = (id) => setEditingPrices(prev => prev.filter(p => p.id !== id));
            const updatePriceRow = (id, field, val) => setEditingPrices(prev => prev.map(p => p.id === id ? { ...p, [field]: parseInt(val) || '' } : p));
            const savePriceEditor = () => {
                const newTable = {};
                editingPrices.forEach(p => { if (p.jpy && p.twd) newTable[p.jpy] = p.twd; });
                setPriceTable(newTable);
                setShowPriceEditor(false);
                notify("åƒ¹æ ¼è¡¨å·²æ›´æ–°");
            };

            // æ–°å¢è¨‚å–®
            const addOrder = () => {
                if (!currentMachine.name) { notify("è«‹è¼¸å…¥æ©Ÿå°/å•†å“åç¨±"); return; }
                if (!inputCustomer) { notify("è«‹è¼¸å…¥é¡§å®¢åç¨±"); return; }

                const unitPriceTWD = currentMachine.priceTWD;
                const ecoTotal = isEco ? (ECO_FEE * inputQty) : 0;
                const variantToSave = currentMachine.variant || 'éš¨æ©Ÿ';
                const cleanCustomer = inputCustomer.trim();

                const newOrder = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    customer: cleanCustomer,
                    productName: currentMachine.name,
                    variant: variantToSave,
                    qty: inputQty,
                    unitPriceJPY: currentMachine.priceJPY,
                    unitPriceTWD: unitPriceTWD,
                    ecoFeePerUnit: isEco ? ECO_FEE : 0,
                    ecoFeeTotal: ecoTotal,
                    gashaTotalJPY: currentMachine.priceJPY * inputQty,
                    gashaTotalTWD: unitPriceTWD * inputQty,
                    customerTotalTWD: (unitPriceTWD * inputQty) + ecoTotal,
                    isPurchased: false,
                    isPicked: false
                };
                setOrders(prev => [newOrder, ...prev]);
                setInputCustomer('');
                setInputQty(1);
                notify(`å·²åŠ å…¥: ${newOrder.customer}`);
            };

            const toggleStatus = (id, field) => {
                setOrders(prev => prev.map(o => o.id === id ? { ...o, [field]: !o[field] } : o));
            };

            const deleteOrder = (id) => {
                triggerConfirm('åˆªé™¤è¨‚å–®', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚', () => {
                    setOrders(prev => prev.filter(o => o.id !== id));
                    notify("è¨‚å–®å·²åˆªé™¤");
                }, 'danger');
            };

            // --- ç·¨è¼¯è¨‚å–®é‚è¼¯ (Update Order) ---
            const handleSaveEditedOrder = () => {
                if (!editingOrder) return;
                
                // é‡æ–°è¨ˆç®—é‡‘é¡
                const ecoTotal = editingOrder.ecoFeePerUnit > 0 ? (ECO_FEE * editingOrder.qty) : 0;
                const totalTWD = (editingOrder.unitPriceTWD * editingOrder.qty) + ecoTotal;
                const totalJPY = editingOrder.unitPriceJPY * editingOrder.qty;
                const totalGashaTWD = editingOrder.unitPriceTWD * editingOrder.qty;

                setOrders(prev => prev.map(o => o.id === editingOrder.id ? {
                    ...o,
                    productName: editingOrder.productName,
                    variant: editingOrder.variant || 'éš¨æ©Ÿ',
                    qty: editingOrder.qty,
                    unitPriceTWD: editingOrder.unitPriceTWD, // å…è¨±ä¿®æ”¹å–®åƒ¹
                    ecoFeePerUnit: editingOrder.ecoFeePerUnit,
                    ecoFeeTotal: ecoTotal,
                    gashaTotalJPY: totalJPY,
                    gashaTotalTWD: totalGashaTWD,
                    customerTotalTWD: totalTWD
                } : o));

                setEditingOrder(null);
                notify("è¨‚å–®å·²æ›´æ–°");
            };

            const handleClearAllData = () => {
                triggerConfirm('âš ï¸ å±éšªæ“ä½œ', 'æ­¤æ“ä½œå°‡ã€Œæ°¸ä¹…æ¸…é™¤æ‰€æœ‰è¨‚å–®è³‡æ–™ã€ï¼\n(åƒ¹æ ¼è¨­å®šæœƒä¿ç•™)\n\næ‚¨ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', () => {
                    setOrders([]);
                    notify("ç³»çµ±è³‡æ–™å·²æ¸…ç©º");
                    setShowGlobalSettings(false);
                }, 'danger');
            };

            const handleImportBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.orders) {
                            triggerConfirm('é‚„åŸå‚™ä»½', `å‚™ä»½æ™‚é–“: ${data.timestamp}\n\nç¢ºå®šé‚„åŸï¼Ÿé€™å°‡è¦†è“‹æ‚¨ç›®å‰æ‰€æœ‰çš„è³‡æ–™ï¼`, () => {
                                setOrders(data.orders);
                                if(data.priceTable) setPriceTable(data.priceTable);
                                notify("è³‡æ–™é‚„åŸæˆåŠŸ");
                                setShowGlobalSettings(false);
                            }, 'danger');
                        } else {
                            notify("ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆ");
                        }
                    } catch (err) { notify("è®€å–å¤±æ•—ï¼Œæ ¼å¼éŒ¯èª¤"); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            const handleExportBackup = () => {
                const data = { orders, priceTable, timestamp: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                saveAs(blob, `CuiboGasha_Backup_${new Date().toISOString().slice(0,10)}.json`);
                notify("å®Œæ•´å‚™ä»½å·²ä¸‹è¼‰");
            };

            const handleExportCSV = () => {
                const bom = "\uFEFF"; 
                const header = "è¨‚å–®æ—¥æœŸ,é¡§å®¢åç¨±,æ©Ÿå°åç¨±,æ¬¾å¼,æ•¸é‡,å–®åƒ¹(æ—¥å¹£),å–®åƒ¹(å°å¹£),ç’°ä¿è²»å°è¨ˆ,å°å¹£ç¸½é‡‘é¡,æŠ•å¹£ç‹€æ…‹,æ’¿è²¨ç‹€æ…‹\n";
                const rows = orders.map(o => `${o.date},${o.customer},${o.productName},${o.variant},${o.qty},${o.unitPriceJPY},${o.unitPriceTWD},${o.ecoFeeTotal},${o.customerTotalTWD},${o.isPurchased?'å·²æŠ•':'æœªæŠ•'},${o.isPicked?'å·²æ’¿':'æœªæ’¿'}`).join("\n");
                const blob = new Blob([bom + header + rows], { type: "text/csv;charset=utf-8" });
                saveAs(blob, `CuiboGasha_Sheet_${new Date().toISOString().slice(0,10)}.csv`);
                notify("CSV å·²åŒ¯å‡º");
            };

            const handleCloudUpload = async () => {
                if(!apiUrl) { notify("è«‹å…ˆè¨­å®š Google Script URL"); return; }
                setIsSyncing(true);
                try {
                    await fetch(apiUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ orders, priceTable, timestamp: new Date().toISOString() }) });
                    notify("å·²ç™¼é€ä¸Šå‚³è«‹æ±‚");
                } catch(e) { notify("ä¸Šå‚³å¤±æ•—"); } finally { setIsSyncing(false); }
            };

            const handleCloudDownload = async () => {
                if(!apiUrl) { notify("è«‹å…ˆè¨­å®š Google Script URL"); return; }
                setIsSyncing(true);
                try {
                    const res = await fetch(apiUrl);
                    if (!res.ok) throw new Error('Error');
                    const data = await res.json();
                    if(data.orders){
                        triggerConfirm('é›²ç«¯åŒæ­¥', `é›²ç«¯å‚™ä»½æ™‚é–“: ${data.timestamp}\n\nç¢ºå®šä¸‹è¼‰ä¸¦è¦†è“‹ç›®å‰è³‡æ–™ï¼Ÿ`, () => {
                            setOrders(data.orders);
                            if(data.priceTable) setPriceTable(data.priceTable);
                            notify("é›²ç«¯åŒæ­¥æˆåŠŸ");
                            setShowGlobalSettings(false);
                        }, 'danger');
                    } else { notify("é›²ç«¯ç„¡è³‡æ–™"); }
                } catch(e) { notify("ä¸‹è¼‰å¤±æ•—"); } finally { setIsSyncing(false); }
            };

            // --- 5. é¡§å®¢è©³æƒ…åŠŸèƒ½ ---
            const handleCopyOrderText = (customer) => {
                if (!customer) return;
                let text = `è¦ªæ„›çš„ ${customer.name} æ‚¨å¥½ï¼Œ\næ‚¨æœ¬æ¬¡çš„é€£ç·šè³¼ç‰©æ˜ç´°å¦‚ä¸‹ï¼š\n\n`;
                customer.items.forEach(item => { text += `${item.productName} ${item.variant !== 'éš¨æ©Ÿ' ? `(${item.variant})` : ''} x ${item.qty} $${item.customerTotalTWD}${item.ecoFeeTotal > 0 ? ` (å«ç’°ä¿è²»)` : ''}\n`; });
                text += `----------------\næ¶ˆè²»ç¸½é¡ï¼š$${customer.totalSpent.toLocaleString()}\n\nå¯ä»¥å…ˆå¹«æˆ‘æ­æ³¢å»å¯\næœ‰èª¤çš„è©±ï½è«‹è¶•å¿«è·Ÿæˆ‘èªªï¼\nâ‚ŠâŠ¹ è‹¥æ˜¯æ²’æœ‰æ¼æ‰çš„å•†å“ â‚ŠâŠ¹\nå°±å¯ä»¥ç›´æ¥çµå¸³å›‰ï¼\nç¶²å€ï¼šï¼ˆé€™è£¡ç•™çµ¦æˆ‘è‡ªå·±è¼¸å…¥ç¶²å€ï¼‰\næ‰¾åˆ°è‡ªå·±åå­—å¾Œå®Œæˆä¸‹å–®å°±å¯ä»¥åš•\nğ™š æ”¶åˆ°æ‰€æœ‰é€£çµå¾Œè«‹ç›¡é€Ÿå®Œæˆä»˜æ¬¾\n   ä¸è¦è€½èª¤åˆ°æœ€ä½³çš„è³å‘³æœŸé™å”·\n\nâš p.s. å‰ä¸€æ¬¡é€£ç·šæœ‰é–‹ç®±åˆ†äº«çš„æœ‹å‹~\nä¸‹å–®å¾Œè«‹å¹«æˆ‘å‚™è¨»ä¸€ä¸‹ï¼šé–‹ç®±ç¦®\nğ­ğ¡ğšğ§ğ¤ ğ²ğ¨ğ® (â€â€¢ ÖŠ â€¢â€)à©­`;
                const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select();
                try { document.execCommand('copy'); notify("æ–‡æ¡ˆå·²è¤‡è£½ï¼"); } catch (err) { notify("è¤‡è£½å¤±æ•—"); }
                document.body.removeChild(textArea);
            };

            const handleExportToImage = async (customer) => {
                if (!customer) return;
                setExportTargetCustomer(customer);
                await new Promise(resolve => setTimeout(resolve, 100));
                const element = document.getElementById('hidden-receipt-container');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#FCF4E9', scale: 2 });
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a'); link.download = `${customer.name}_æ‰­è›‹æ˜ç´°.png`; link.href = dataUrl; link.click();
                    notify("åœ–ç‰‡å·²ä¸‹è¼‰");
                } catch (err) { notify("åŒ¯å‡ºå¤±æ•—"); } finally { setExportTargetCustomer(null); }
            };

            // --- 6. ä»‹é¢æ¸²æŸ“ ---
            return (
                <div className="min-h-screen pb-24 relative">
                    
                    {/* App é¢¨æ ¼ç¢ºèªå°è©±æ¡† */}
                    {confirmConfig && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl space-y-4 border border-cream-200">
                                <h3 className={`font-bold text-xl flex items-center gap-2 ${confirmConfig.type === 'danger' ? 'text-rose-500' : 'text-latte-800'}`}>
                                    {confirmConfig.type === 'danger' && <AlertCircle size={24}/>}
                                    {confirmConfig.title}
                                </h3>
                                <p className="text-latte-600 text-sm whitespace-pre-line leading-relaxed font-medium">
                                    {confirmConfig.message}
                                </p>
                                <div className="flex gap-3 pt-2">
                                    <button onClick={() => setConfirmConfig(null)} className="flex-1 py-3.5 rounded-2xl font-bold bg-cream-100 text-latte-500 hover:bg-cream-200 active:scale-95 transition-all">å–æ¶ˆ</button>
                                    <button onClick={() => { confirmConfig.onConfirm(); setConfirmConfig(null); }} className={`flex-1 py-3.5 rounded-2xl font-bold text-white shadow-lg active:scale-95 transition-all flex justify-center items-center gap-1 ${confirmConfig.type === 'danger' ? 'bg-rose-500 shadow-rose-200 hover:bg-rose-600' : 'bg-latte-500 shadow-latte-200 hover:bg-latte-600'}`}>
                                        {confirmConfig.type === 'danger' ? <Trash2 size={18}/> : <CheckCircle2 size={18}/>}
                                        ç¢ºèª
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Order Edit Modal (æ–°å¢çš„è¨‚å–®ç·¨è¼¯è¦–çª—) */}
                    {editingOrder && (
                        <div className="fixed inset-0 z-[250] flex items-center justify-center p-4 bg-latte-900/40 backdrop-blur-sm animate-in">
                            <div className="bg-white rounded-[30px] w-full max-w-sm p-6 shadow-2xl space-y-4 flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> ç·¨è¼¯è¨‚å–®</h3>
                                    <button onClick={()=>setEditingOrder(null)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>
                                <div className="space-y-3 overflow-y-auto max-h-[60vh] p-1">
                                    <div>
                                        <label className="text-xs font-bold text-latte-400 ml-1">é¡§å®¢åç¨± (å”¯è®€)</label>
                                        <div className="w-full bg-cream-50 p-3 rounded-xl font-bold text-latte-600">{editingOrder.customer}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-latte-400 ml-1">æ©Ÿå°åç¨±</label>
                                        <input className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none focus:border-latte-400 font-bold text-latte-800" value={editingOrder.productName} onChange={e=>setEditingOrder({...editingOrder, productName: e.target.value})}/>
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="text-xs font-bold text-latte-400 ml-1">æ¬¾å¼</label>
                                            <input className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none focus:border-latte-400 font-bold text-latte-800" value={editingOrder.variant} onChange={e=>setEditingOrder({...editingOrder, variant: e.target.value})}/>
                                        </div>
                                        <div className="w-24">
                                            <label className="text-xs font-bold text-latte-400 ml-1">æ•¸é‡</label>
                                            <div className="flex items-center bg-white border border-cream-200 rounded-xl p-1">
                                                <button onClick={()=>setEditingOrder({...editingOrder, qty: Math.max(1, editingOrder.qty-1)})} className="w-8 h-8 flex items-center justify-center text-latte-400 active:scale-90"><Minus size={14}/></button>
                                                <span className="flex-1 text-center font-bold text-latte-800">{editingOrder.qty}</span>
                                                <button onClick={()=>setEditingOrder({...editingOrder, qty: editingOrder.qty+1})} className="w-8 h-8 flex items-center justify-center text-latte-400 active:scale-90"><Plus size={14}/></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-latte-400 ml-1">å–®åƒ¹ (NT$)</label>
                                        <input type="number" className="w-full bg-white border border-cream-200 p-3 rounded-xl outline-none focus:border-latte-400 font-bold text-latte-800" value={editingOrder.unitPriceTWD} onChange={e=>setEditingOrder({...editingOrder, unitPriceTWD: parseInt(e.target.value)||0})}/>
                                    </div>
                                    <button onClick={()=>setEditingOrder({...editingOrder, ecoFeePerUnit: editingOrder.ecoFeePerUnit > 0 ? 0 : ECO_FEE})} className={`w-full py-3 rounded-xl border-2 font-bold transition-all flex items-center justify-center gap-2 ${editingOrder.ecoFeePerUnit > 0 ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300'}`}>
                                        <span className="text-xs">ç’°ä¿è²»ç‹€æ…‹:</span>
                                        {editingOrder.ecoFeePerUnit > 0 ? 'å·²å•Ÿç”¨ (+10)' : 'æœªå•Ÿç”¨'}
                                    </button>
                                </div>
                                <button onClick={handleSaveEditedOrder} className="w-full bg-latte-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition">å„²å­˜è®Šæ›´</button>
                            </div>
                        </div>
                    )}

                    {/* Hidden Receipt */}
                    {exportTargetCustomer && (
                        <div id="hidden-receipt-container">
                            <div className="receipt-card">
                                <div className="receipt-header">
                                    <div className="receipt-title">{exportTargetCustomer.name} çš„æ‰­è›‹æ¸…å–®</div>
                                    <div className="receipt-subtitle">{new Date().toLocaleString()}</div>
                                </div>
                                <div className="receipt-info"><span>è¨‚å–®: {Date.now().toString().slice(-6)}</span><span>å®¢æˆ¶: {exportTargetCustomer.name}</span></div>
                                <table className="receipt-table">
                                    <thead><tr><th className="col-name">æ©Ÿå° / è¦æ ¼</th><th className="col-price">å–®åƒ¹</th><th className="col-qty">æ•¸</th><th className="col-total">å°è¨ˆ</th></tr></thead>
                                    <tbody>
                                        {exportTargetCustomer.items.map((item, idx) => (
                                            <tr key={idx}><td className="col-name"><span className="item-name">{item.productName}</span><span className="item-spec">{item.variant}{item.ecoFeeTotal > 0 && <span className="item-eco">å«ç’°ä¿è²»</span>}</span></td><td className="col-price">${item.unitPriceTWD}</td><td className="col-qty">{item.qty}</td><td className="col-total">${item.customerTotalTWD}</td></tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="receipt-summary"><div className="summary-total"><span>ç¸½é‡‘é¡:</span><span>${exportTargetCustomer.totalSpent.toLocaleString()}</span></div></div>
                                <div className="receipt-footer">æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼(â€â€¢ ÖŠ â€¢â€)à©­</div>
                            </div>
                        </div>
                    )}

                    {/* Toast */}
                    {notification && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[300] bg-latte-800 text-cream-50 px-6 py-3 rounded-2xl shadow-xl flex items-center gap-2 animate-in border border-latte-600"><CheckCircle2 size={18} className="text-cream-200" />{notification}</div>}

                    {/* Header */}
                    <div className="bg-latte-500 text-cream-50 p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto shadow-latte-200">
                        <h1 className="text-xl font-bold flex items-center gap-2"><Zap className="fill-cream-100 text-cream-100" /> Cuibo Gasha</h1>
                        <div className="flex gap-2 items-center">
                            <div className="text-xs bg-latte-600 px-2 py-1 rounded-lg">Live</div>
                            <button onClick={()=>setShowGlobalSettings(true)} className="p-1.5 rounded-lg hover:bg-latte-600 transition text-cream-100"><Settings size={20}/></button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="bg-white/90 backdrop-blur-sm border-b border-cream-200 sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'input',l:'é€£ç·š',i:Plus},{id:'list',l:'æ¸…å–®',i:ListOrdered},{id:'customers',l:'é¡§å®¢',i:Users},{id:'dashboard',l:'å„€è¡¨æ¿',i:LayoutDashboard}].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setSearchQuery('')}} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[11px] font-bold transition-all ${activeTab === t.id ? 'text-latte-500 border-b-2 border-latte-500 bg-cream-50' : 'text-latte-300'}`}>
                                    <div className="relative"><t.i size={20}/>{t.id === 'list' && stats.pendingPick > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border border-white"></span>}</div>{t.l}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-5">
                        {/* 1. Input Tab */}
                        {activeTab === 'input' && (
                            <div className="space-y-4 animate-in">
                                
                                {/* 1. é¡§å®¢åç¨± (Customer Input) */}
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-cream-100 rounded-full flex items-center justify-center text-latte-400"><User size={20}/></div>
                                        <input 
                                            type="text" 
                                            placeholder="èª°è¦è²·? (è¼¸å…¥é¡§å®¢å)" 
                                            className="flex-1 bg-cream-50 rounded-xl py-3 px-4 font-bold text-lg outline-none focus:ring-2 ring-latte-300 text-latte-800"
                                            value={inputCustomer}
                                            onChange={e => setInputCustomer(e.target.value)}
                                        />
                                    </div>
                                </div>

                                {/* 2. æ©Ÿå°è¨­å®š (Machine Settings) */}
                                <div className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="text-xs font-bold text-latte-400 tracking-wider flex items-center gap-1"><Tag size={12}/> æ©Ÿå°è¨­å®š (é–å®šä¸­)</div>
                                        <button onClick={openPriceEditor} className="text-[10px] text-latte-500 bg-cream-100 px-2 py-1 rounded border border-cream-200 flex items-center gap-1 hover:bg-cream-200 active:scale-95 transition"><Edit size={10}/> ç·¨è¼¯åƒ¹æ ¼</button>
                                    </div>
                                    <input 
                                        type="text" 
                                        placeholder="è¼¸å…¥æ©Ÿå°åç¨± (ä¾‹: å‰ä¼Šå¡å“‡)" 
                                        className="w-full text-lg font-bold border-b-2 border-cream-200 focus:border-latte-400 outline-none pb-2 mb-4 placeholder-latte-300 bg-transparent text-latte-800"
                                        value={currentMachine.name}
                                        onChange={e => setCurrentMachine({...currentMachine, name: e.target.value})}
                                    />
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {Object.keys(priceTable).map(Number).sort((a,b)=>a-b).map(price => (
                                            <button 
                                                key={price}
                                                onClick={() => handlePriceSelect(price)}
                                                className={`py-2 rounded-xl text-sm font-bold transition-all ${currentMachine.priceJPY === price ? 'price-btn-active' : 'price-btn'}`}
                                            >
                                                Â¥{price}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center bg-cream-50 p-3 rounded-2xl border border-cream-200">
                                        <div className="text-xs text-latte-400 font-bold">è‡ªå‹•æ›ç®—</div>
                                        <div className="font-black text-latte-600 flex items-baseline gap-1">
                                            <span className="text-sm font-normal text-latte-400">Â¥{currentMachine.priceJPY} =</span>
                                            <span className="text-xl">NT${currentMachine.priceTWD}</span>
                                        </div>
                                    </div>
                                    <div className="mt-3">
                                        <input 
                                            type="text" 
                                            placeholder="æ¬¾å¼ (é è¨­éš¨æ©Ÿ)" 
                                            className="w-full text-sm bg-cream-50 rounded-xl p-3 outline-none text-latte-800"
                                            value={currentMachine.variant}
                                            onChange={e => setCurrentMachine({...currentMachine, variant: e.target.value})}
                                        />
                                    </div>
                                </div>

                                {/* 3. åŠ å…¥æ¸…å–® & æ•¸é‡ (Action Card) */}
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3 bg-cream-50 rounded-full p-1 border border-cream-200">
                                            <button onClick={() => setInputQty(Math.max(1, inputQty-1))} className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-latte-400 active:scale-90 transition"><Minus size={18}/></button>
                                            <span className="text-xl font-black w-8 text-center text-latte-800">{inputQty}</span>
                                            <button onClick={() => setInputQty(inputQty+1)} className="w-10 h-10 rounded-full bg-latte-500 text-white shadow-md flex items-center justify-center active:scale-90 transition"><Plus size={18}/></button>
                                        </div>
                                        <button 
                                            onClick={() => setIsEco(!isEco)}
                                            className={`flex flex-col items-center justify-center px-4 py-2 rounded-2xl border-2 transition-all ${isEco ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300 bg-white'}`}
                                        >
                                            <span className="text-[10px] font-bold">æ‹†æ®¼/ç’°ä¿</span>
                                            <span className="font-bold text-sm">+{isEco ? `$${ECO_FEE*inputQty}` : '$0'}</span>
                                        </button>
                                    </div>
                                    <button onClick={addOrder} className="w-full bg-latte-800 text-cream-50 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-latte-800/20 active:scale-98 transition flex items-center justify-center gap-2 hover:brightness-110">
                                        <span>åŠ å…¥æ¸…å–®</span>
                                        <span className="bg-white/20 px-2 py-0.5 rounded text-sm">
                                            ${(currentMachine.priceTWD * inputQty) + (isEco ? ECO_FEE * inputQty : 0)}
                                        </span>
                                    </button>
                                </div>
                                {orders.length > 0 && <div className="text-center text-xs text-latte-400 opacity-70">å‰›åŠ å…¥: {orders[0].customer} - {orders[0].productName} (${orders[0].customerTotalTWD})</div>}
                            </div>
                        )}

                        {/* 2. List Tab */}
                        {activeTab === 'list' && (
                            <div className="space-y-3 animate-in">
                                <div className="relative mb-4"><input type="text" placeholder="æœå°‹æ©Ÿå°ã€é¡§å®¢ã€æ¬¾å¼..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-white rounded-xl p-3 pl-10 border border-cream-200 outline-none focus:border-latte-400 text-latte-800" /><Search size={16} className="absolute left-3 top-3.5 text-latte-300" /></div>
                                {filteredOrders.map(o => (
                                    <div key={o.id} className={`bg-white p-4 rounded-3xl shadow-soft border border-cream-200 transition-all ${o.isPicked ? 'opacity-60 bg-cream-50' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div><div className="font-bold text-latte-800 text-lg">{o.customer}</div><div className="text-xs text-latte-500 font-bold">{o.productName} <span className="text-latte-300 font-normal">({o.variant})</span></div><div className="mt-1 text-xs bg-cream-100 inline-block px-2 py-0.5 rounded text-latte-600 font-bold border border-cream-200">Â¥{o.unitPriceJPY} x {o.qty}{o.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1">+ç’°ä¿</span>}</div></div>
                                            <div className="text-right">
                                                <div className="text-xl font-black text-latte-600">${o.customerTotalTWD}</div>
                                                <div className="flex gap-2 justify-end mt-1">
                                                    <button onClick={() => setEditingOrder(o)} className="text-latte-400 p-2 hover:text-latte-600 bg-cream-50 rounded-lg active:scale-95 transition"><Edit size={16}/></button>
                                                    <button onClick={() => deleteOrder(o.id)} className="text-cream-300 p-2 hover:text-rose-400 bg-cream-50 rounded-lg active:scale-95 transition"><Trash2 size={16}/></button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => toggleStatus(o.id, 'isPurchased')} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 transition-colors border ${o.isPurchased ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><Coins size={14}/> {o.isPurchased ? 'å·²æŠ•å¹£' : 'æœªæŠ•å¹£'}</button>
                                            <button onClick={() => toggleStatus(o.id, 'isPicked')} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 transition-colors border ${o.isPicked ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><ShoppingBag size={14}/> {o.isPicked ? 'å·²æ’¿è²¨' : 'æœªæ’¿è²¨'}</button>
                                        </div>
                                    </div>
                                ))}
                                {filteredOrders.length === 0 && <div className="text-center text-latte-300 py-10">æ²’æœ‰ç¬¦åˆçš„è¨‚å–®</div>}
                            </div>
                        )}

                        {/* 3. Customers Tab */}
                        {activeTab === 'customers' && (
                            <div className="space-y-2 animate-in">
                                <div className="flex justify-between items-center px-2 mb-2"><span className="text-xs font-bold text-latte-400">å…± {filteredCustomers.length} ä½é¡§å®¢</span></div>
                                {filteredCustomers.map(c => (
                                    <div key={c.name} onClick={() => setSelectedCustomerDetail(c)} className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200 flex justify-between items-center cursor-pointer mb-2 active:scale-[0.99] transition-all hover:border-latte-200">
                                        <div className="flex items-center gap-4"><div className="w-12 h-12 bg-cream-100 text-latte-600 rounded-full flex items-center justify-center font-bold border border-cream-200 text-lg shadow-sm">{c.name[0]}</div><div><h4 className="font-bold text-latte-800 text-lg">{c.name}</h4><p className="text-xs text-latte-400">{c.orderCount} ç­†è¨‚å–®</p></div></div>
                                        <div className="text-right"><p className="font-black text-latte-500 text-lg">${c.totalSpent.toLocaleString()}</p><div className="text-[10px] text-latte-300 bg-cream-50 px-2 py-0.5 rounded-lg inline-block">é»æ“ŠæŸ¥çœ‹</div></div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 4. Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-4 animate-in">
                                <div className="bg-[#D98E73] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Coins size={80}/></div><p className="text-xs font-bold opacity-90 tracking-wider">æ—¥å¹£ç¸½æŠ•éœ€æ±‚</p><p className="text-3xl font-black mt-2">Â¥{stats.totalJPY.toLocaleString()}</p><p className="text-xs opacity-70 mt-1">å…± {stats.totalCount} é¡†</p></div>
                                <div className="bg-[#BF9E85] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><DollarSign size={80}/></div><p className="text-xs font-bold opacity-90 tracking-wider">é ä¼°å°å¹£ç‡Ÿæ”¶</p><p className="text-3xl font-black mt-2">${stats.totalRevenue.toLocaleString()}</p></div>
                                <div className="col-span-2 bg-white p-6 rounded-3xl border border-cream-200 shadow-sm flex justify-around text-center"><div><div className="text-3xl font-black text-latte-400">{stats.pendingPurchase}</div><div className="text-xs text-latte-300 font-bold mt-1">æœªæŠ•å¹£</div></div><div className="w-px bg-cream-200"></div><div><div className="text-3xl font-black text-latte-600">{stats.pendingPick}</div><div className="text-xs text-latte-300 font-bold mt-1">å¾…æ’¿è²¨</div></div></div>
                            </div>
                        )}
                    </main>

                    {/* --- Global Settings Modal --- */}
                    {showGlobalSettings && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-5 shadow-2xl animate-in max-h-[85vh] overflow-y-auto">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Settings size={20}/> ç³»çµ±è¨­å®š</h3><button onClick={()=>setShowGlobalSettings(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="space-y-3">
                                    <h4 className="text-xs font-bold text-latte-400 uppercase tracking-wide">Google é›²ç«¯åŒæ­¥ (Apps Script)</h4>
                                    <input type="text" placeholder="è¼¸å…¥ Google Apps Script URL..." className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl outline-none text-latte-800 text-xs focus:border-latte-400" value={apiUrl} onChange={e=>setApiUrl(e.target.value)}/>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={handleCloudUpload} disabled={isSyncing} className="bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">{isSyncing ? <Loader2 size={18} className="animate-spin"/> : <Cloud size={18}/>}<span className="text-xs">ä¸Šå‚³é›²ç«¯ (å‚™ä»½)</span></button>
                                        <button onClick={handleCloudDownload} disabled={isSyncing} className="bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-md shadow-emerald-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">{isSyncing ? <Loader2 size={18} className="animate-spin"/> : <RefreshCcw size={18}/>}<span className="text-xs">ä¸‹è¼‰åŒæ­¥ (é‚„åŸ)</span></button>
                                    </div>
                                </div>
                                <div className="space-y-3 pt-2 border-t border-cream-100">
                                    <h4 className="text-xs font-bold text-latte-400 uppercase tracking-wide">æœ¬æ©Ÿè³‡æ–™ç®¡ç†</h4>
                                    <button onClick={handleExportCSV} className="w-full bg-white border border-latte-200 text-latte-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95 transition"><FileSpreadsheet size={18} className="text-green-600"/> åŒ¯å‡º Excel / Sheets (CSV)</button>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={handleExportBackup} className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition"><FileJson size={16}/> å‚™ä»½æª”æ¡ˆ</button>
                                        <label className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition cursor-pointer"><Upload size={16}/> é‚„åŸæª”æ¡ˆ<input type="file" className="hidden" ref={fileInputRef} onChange={handleImportBackup} accept=".json"/></label>
                                    </div>
                                    <button onClick={handleClearAllData} className="w-full bg-rose-50 border border-rose-100 text-rose-500 py-3 rounded-xl font-bold mt-2 flex items-center justify-center gap-2 active:scale-95 transition hover:bg-rose-100"><Trash2 size={18}/> æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Price Editor Modal */}
                    {showPriceEditor && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-4 shadow-2xl animate-in max-h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3"><h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> å®šåƒ¹ç®¡ç†</h3><button onClick={()=>setShowPriceEditor(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-2 p-1">
                                    <div className="flex gap-2 text-xs font-bold text-latte-400 px-2"><span className="flex-1">æ—¥å¹£ (Â¥)</span><span className="flex-1">å°å¹£ ($)</span><span className="w-8"></span></div>
                                    {editingPrices.map(p => (
                                        <div key={p.id} className="flex gap-2 items-center">
                                            <input type="number" placeholder="æ—¥å¹£" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-800 outline-none focus:border-latte-400" value={p.jpy} onChange={e=>updatePriceRow(p.id, 'jpy', e.target.value)}/>
                                            <ArrowRight size={14} className="text-latte-300"/>
                                            <input type="number" placeholder="å°å¹£" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-600 outline-none focus:border-latte-400" value={p.twd} onChange={e=>updatePriceRow(p.id, 'twd', e.target.value)}/>
                                            <button onClick={()=>removePriceRow(p.id)} className="w-8 h-8 flex items-center justify-center text-cream-300 hover:text-rose-500 rounded-full hover:bg-rose-50 transition"><Trash2 size={16}/></button>
                                        </div>
                                    ))}
                                    <button onClick={addPriceRow} className="w-full py-3 border border-dashed border-latte-300 rounded-xl text-latte-400 text-sm font-bold hover:bg-cream-50 hover:text-latte-600 transition flex items-center justify-center gap-1"><Plus size={16}/> æ–°å¢åƒ¹æ ¼ç´šè·</button>
                                </div>
                                <button onClick={savePriceEditor} className="w-full bg-latte-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition">å„²å­˜è¨­å®š</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
