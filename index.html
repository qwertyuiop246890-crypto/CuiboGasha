<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuibo Gasha WMS Pro</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• Babel Áî®ÊñºËß£Êûê JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. ËºâÂÖ•Â§ñÈÉ®Â•ó‰ª∂ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- 4. Ë®≠ÂÆöËá™ÂÆöÁæ©È°èËâ≤ (Tailwind Config) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: {
                            50: '#FFFBF5',  // Ëº∏ÂÖ•Ê°Ü/Ê•µÊ∑∫Â∫ï
                            100: '#FCF4E9', // ÂÖ®Âüü‰∏ªËÉåÊôØ
                            200: '#EBE0D6', // ÈÇäÊ°Ü/ÂàÜÈöîÁ∑ö
                            300: '#D3C5BC', // Â§±ÊïàÊñáÂ≠ó
                        },
                        latte: {
                            400: '#B5A496', // ËºîÂä©ÊñáÂ≠ó
                            500: '#957E6B', // ‰∏ªÂº∑Ë™øËâ≤ (Brand Color)
                            600: '#8C6A5D', // Ê∑±‰∏ÄÈªûÁöÑÂº∑Ë™ø
                            800: '#5E4B41', // ‰∏ªË¶ÅÊñáÂ≠ó (Ê∑±ÂíñÂï°)
                            900: '#4A3B32', // Ê•µÊ∑±Ëâ≤
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -5px rgba(149, 126, 107, 0.1)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                    },
                    animation: {
                        'in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* ÂÖ®ÂüüÊ®£ÂºèË®≠ÂÆö */
        body {
            background-color: #FCF4E9; /* ‰∏ªËâ≤Ë™ø */
            color: #5E4B41; /* ‰∏ªË¶ÅÊñáÂ≠óÈ°èËâ≤ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            touch-action: manipulation; /* ÂÑ™ÂåñËß∏Êéß */
        }

        /* Èö±ËóèÂç∑Ëª∏‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ÁßªÈô§ÈªûÊìäÈ´ò‰∫Æ */
        * { -webkit-tap-highlight-color: transparent; }

        /* --- ÂúñÁâáÂåØÂá∫Â∞àÁî®Ê®£Âºè (Èö±ËóèÂçÄÂ°ä) --- */
        #hidden-receipt-container {
            position: fixed;
            top: 0;
            left: -9999px;
            width: 500px;
            background-color: #FCF4E9;
            z-index: -100;
            padding: 40px;
            box-sizing: border-box;
            font-family: sans-serif;
            color: #5E4B41;
            line-height: 1.5;
        }
        
        .receipt-card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(149, 126, 107, 0.15);
            border: 1px solid #EBE0D6;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #D3C5BC;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .receipt-title { font-size: 24px; font-weight: 900; margin-bottom: 5px; color: #5E4B41; letter-spacing: 1px; }
        .receipt-subtitle { font-size: 14px; color: #957E6B; }
        
        .receipt-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 700;
            color: #8C6A5D;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .receipt-table th { text-align: left; font-size: 12px; color: #957E6B; padding-bottom: 8px; border-bottom: 1px solid #EBE0D6; }
        .receipt-table td { padding: 12px 0; border-bottom: 1px dashed #EBE0D6; vertical-align: top; }
        .receipt-table .col-total { text-align: right; }
        .receipt-table .col-price { text-align: right; padding-right: 10px; }
        .receipt-table .col-qty { text-align: center; }
        
        .item-name { font-size: 14px; font-weight: 700; color: #5E4B41; display: block; margin-bottom: 2px; }
        .item-spec { font-size: 12px; color: #B5A496; }
        .item-eco { font-size: 10px; color: #10B981; background: #ECFDF5; padding: 2px 4px; border-radius: 4px; margin-left: 4px; }
        
        .receipt-summary {
            background-color: #FFFBF5;
            padding: 20px;
            border-radius: 12px;
            text-align: right;
            border: 1px solid #EBE0D6;
        }
        .summary-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; color: #957E6B; margin-top: 10px; border-top: 1px solid #EBE0D6; padding-top: 10px; }
        
        .receipt-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #B5A496;
            font-weight: bold;
        }

        /* ÂÉπÊ†ºÊåâÈàïÊ®£Âºè */
        .price-btn-active { background-color: #957E6B; color: #FFFBF5; border-color: #957E6B; box-shadow: 0 4px 6px -1px rgba(149, 126, 107, 0.4); }
        .price-btn { background-color: #FFFBF5; color: #B5A496; border: 1px solid #EBE0D6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            LayoutDashboard, ShoppingBag, Users, Zap, Plus, ArrowRight, AlertCircle, 
            CheckCircle2, Truck, DollarSign, Search, X, ChevronRight, ClipboardList, 
            User, ListOrdered, Tag, CheckSquare, Trash2, Edit, Save, 
            Image as ImageIcon, Download, Loader2, Coins, Circle, ShoppingCart, Settings,
            Cloud, Upload, FileJson, FileSpreadsheet, RefreshCcw
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        const App = () => {
            // --- 1. Ê†∏ÂøÉË®≠ÂÆö (Core Settings) ---
            const DEFAULT_PRICE_TABLE = {
                100: 50, 200: 80, 300: 120, 400: 140, 
                500: 170, 600: 190, 800: 260, 1000: 360, 1500: 450
            };
            const ECO_FEE = 10; // Áí∞‰øùË≤ªÈ†êË®≠ÂÄº

            // --- 2. ÁãÄÊÖãÁÆ°ÁêÜ (State Management) ---
            
            // ËÆÄÂèñ/ÂÑ≤Â≠òË≥áÊñô
            const loadLocal = (key, def) => {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : def;
            };

            // Ë®ÇÂñÆË≥áÊñô
            const [orders, setOrders] = useState(() => loadLocal('cuibo_gasha_orders', []));
            
            // ÂÉπÊ†ºË°® (ÂèØÁ∑®ËºØ)
            const [priceTable, setPriceTable] = useState(() => loadLocal('cuibo_gasha_pricetable', DEFAULT_PRICE_TABLE));

            // API URL
            const [apiUrl, setApiUrl] = useState(() => localStorage.getItem('cuibo_gasha_api_url') || '');

            // Ê©üÂè∞Ë®≠ÂÆö (Ëº∏ÂÖ•ÂçÄÊö´Â≠ò)
            const [currentMachine, setCurrentMachine] = useState({
                name: '',
                priceJPY: 500, // È†êË®≠ 500
                priceTWD: 170, // Â∞çÊáâ 500
                variant: 'Èö®Ê©ü'
            });

            // Ë®ÇÂñÆËº∏ÂÖ• (Ëº∏ÂÖ•ÂçÄÊö´Â≠ò)
            const [inputCustomer, setInputCustomer] = useState('');
            const [inputQty, setInputQty] = useState(1);
            const [isEco, setIsEco] = useState(false);

            // UI ÁãÄÊÖã
            const [activeTab, setActiveTab] = useState('input'); // input, list, customers, dashboard
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCustomerDetail, setSelectedCustomerDetail] = useState(null);
            const [notification, setNotification] = useState(null);
            const [exportTargetCustomer, setExportTargetCustomer] = useState(null); // ÂúñÁâáÂåØÂá∫Áî®
            const [isSyncing, setIsSyncing] = useState(false);
            
            // Á∑®ËºØÂô®ÁãÄÊÖã
            const [showPriceEditor, setShowPriceEditor] = useState(false);
            const [editingPrices, setEditingPrices] = useState([]);
            const [showGlobalSettings, setShowGlobalSettings] = useState(false);

            const fileInputRef = useRef(null);

            // ÊåÅ‰πÖÂåñ
            useEffect(() => { localStorage.setItem('cuibo_gasha_orders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_pricetable', JSON.stringify(priceTable)); }, [priceTable]);
            useEffect(() => { localStorage.setItem('cuibo_gasha_api_url', apiUrl); }, [apiUrl]);

            // --- 3. ÈÇèËºØË®àÁÆó (Calculations) ---

            const notify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            // È°ßÂÆ¢ÂàóË°®ËÅöÂêà
            const customerList = useMemo(() => {
                const map = {};
                orders.forEach(o => {
                    if (!map[o.customer]) {
                        map[o.customer] = { 
                            name: o.customer, 
                            totalSpent: 0, 
                            items: [],
                            orderCount: 0
                        };
                    }
                    map[o.customer].orderCount += 1;
                    map[o.customer].totalSpent += o.customerTotalTWD;
                    
                    map[o.customer].items.push({
                        ...o,
                        itemTotal: o.customerTotalTWD,
                        finalPrice: o.unitPriceTWD
                    });
                });
                return Object.values(map).sort((a,b) => b.totalSpent - a.totalSpent);
            }, [orders]);

            // ÈÅéÊøæÂæåÁöÑÈ°ßÂÆ¢
            const filteredCustomers = customerList.filter(c => c.name.includes(searchQuery));

            // ÂÖ®Â±ÄÁµ±Ë®à
            const stats = useMemo(() => {
                const totalRevenue = orders.reduce((acc, o) => acc + o.customerTotalTWD, 0);
                const totalJPY = orders.reduce((acc, o) => acc + o.gashaTotalJPY, 0);
                const totalCount = orders.reduce((acc, o) => acc + o.qty, 0);
                const pendingPurchase = orders.filter(o => !o.isPurchased).reduce((acc, o) => acc + o.qty, 0);
                const pendingPick = orders.filter(o => o.isPurchased && !o.isPicked).reduce((acc, o) => acc + o.qty, 0);
                return { totalRevenue, totalJPY, totalCount, pendingPurchase, pendingPick };
            }, [orders]);

            const filteredOrders = orders.filter(o => 
                o.customer.includes(searchQuery) || o.productName.includes(searchQuery)
            );

            // --- 4. Êìç‰ΩúËôïÁêÜ (Handlers) ---

            // Ê©üÂè∞ÂÆöÂÉπÈÅ∏Êìá
            const handlePriceSelect = (jpy) => {
                const twd = priceTable[jpy] || 0;
                setCurrentMachine(prev => ({
                    ...prev,
                    priceJPY: jpy,
                    priceTWD: twd
                }));
            };

            // ÂÉπÊ†ºË°®Á∑®ËºØÂô®Áõ∏Èóú
            const openPriceEditor = () => {
                const list = Object.entries(priceTable).map(([jpy, twd]) => ({
                    id: Date.now() + Math.random(),
                    jpy: parseInt(jpy),
                    twd: parseInt(twd)
                }));
                list.sort((a,b) => a.jpy - b.jpy);
                setEditingPrices(list);
                setShowPriceEditor(true);
            };

            const addPriceRow = () => {
                setEditingPrices(prev => [...prev, { id: Date.now(), jpy: '', twd: '' }]);
            };

            const removePriceRow = (id) => {
                setEditingPrices(prev => prev.filter(p => p.id !== id));
            };

            const updatePriceRow = (id, field, val) => {
                setEditingPrices(prev => prev.map(p => p.id === id ? { ...p, [field]: parseInt(val) || '' } : p));
            };

            const savePriceEditor = () => {
                const newTable = {};
                editingPrices.forEach(p => {
                    if (p.jpy && p.twd) {
                        newTable[p.jpy] = p.twd;
                    }
                });
                setPriceTable(newTable);
                setShowPriceEditor(false);
                notify("ÂÉπÊ†ºË°®Â∑≤Êõ¥Êñ∞");
            };

            // Êñ∞Â¢ûË®ÇÂñÆ
            const addOrder = () => {
                if (!currentMachine.name) { notify("Ë´ãËº∏ÂÖ•Ê©üÂè∞/ÂïÜÂìÅÂêçÁ®±"); return; }
                if (!inputCustomer) { notify("Ë´ãËº∏ÂÖ•È°ßÂÆ¢ÂêçÁ®±"); return; }

                const unitPriceTWD = currentMachine.priceTWD;
                const ecoTotal = isEco ? (ECO_FEE * inputQty) : 0;
                
                const gashaTotalJPY = currentMachine.priceJPY * inputQty;
                const gashaTotalTWD = unitPriceTWD * inputQty;
                const customerTotalTWD = gashaTotalTWD + ecoTotal;

                const newOrder = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    customer: inputCustomer,
                    productName: currentMachine.name,
                    variant: currentMachine.variant,
                    qty: inputQty,
                    unitPriceJPY: currentMachine.priceJPY,
                    unitPriceTWD: unitPriceTWD,
                    ecoFeePerUnit: isEco ? ECO_FEE : 0,
                    ecoFeeTotal: ecoTotal,
                    gashaTotalJPY: gashaTotalJPY,
                    gashaTotalTWD: gashaTotalTWD,
                    customerTotalTWD: customerTotalTWD,
                    isPurchased: false,
                    isPicked: false
                };

                setOrders(prev => [newOrder, ...prev]);
                setInputCustomer('');
                setInputQty(1);
                notify(`Â∑≤Âä†ÂÖ•: ${newOrder.customer}`);
            };

            const toggleStatus = (id, field) => {
                setOrders(prev => prev.map(o => o.id === id ? { ...o, [field]: !o[field] } : o));
            };

            const deleteOrder = (id) => {
                if(confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á≠ÜË®ÇÂñÆÔºü")) setOrders(prev => prev.filter(o => o.id !== id));
            };

            // --- Ë≥áÊñôÁÆ°ÁêÜÂäüËÉΩ (Data Management) ---

            const handleClearAllData = () => {
                if(confirm("‚ö†Ô∏è Âö¥ÈáçË≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞áÊ∏ÖÈô§„ÄåÊâÄÊúâË®ÇÂñÆË≥áÊñô„ÄçÔºÅ\n\n(ÊÇ®ÁöÑËá™Ë®ÇÂÉπÊ†ºË°®ËàáAPIË®≠ÂÆöÊúÉ‰øùÁïô)\n\nÁ¢∫ÂÆöË¶ÅÂü∑Ë°åÂóéÔºü")) {
                    if(confirm("ÂÜçÊ¨°Á¢∫Ë™çÔºöÊÇ®Â∑≤Á∂ìÂÇô‰ªΩ‰∫ÜÂóéÔºüÂà™Èô§ÂæåÁÑ°Ê≥ïÂæ©ÂéüÔºÅ")) {
                        setOrders([]);
                        notify("Á≥ªÁµ±Ë≥áÊñôÂ∑≤Ê∏ÖÁ©∫");
                        setShowGlobalSettings(false);
                    }
                }
            };

            // 1. JSON ÂÇô‰ªΩ/ÈÇÑÂéü (Local Backup)
            const handleExportBackup = () => {
                const data = { orders, priceTable, timestamp: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                saveAs(blob, `CuiboGasha_Backup_${new Date().toISOString().slice(0,10)}.json`);
                notify("ÂÆåÊï¥ÂÇô‰ªΩÂ∑≤‰∏ãËºâ");
            };

            const handleImportBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.orders) {
                            if(confirm(`Á¢∫ÂÆöÈÇÑÂéüÂÇô‰ªΩÊ™îÔºü\nÂÇô‰ªΩÊôÇÈñì: ${data.timestamp}\n\nÈÄôÂ∞áË¶ÜËìãÊÇ®Áï∂ÂâçÁöÑË≥áÊñôÔºÅ`)) {
                                setOrders(data.orders);
                                if(data.priceTable) setPriceTable(data.priceTable);
                                notify("Ë≥áÊñôÈÇÑÂéüÊàêÂäü");
                                setShowGlobalSettings(false);
                            }
                        } else {
                            notify("ÁÑ°ÊïàÁöÑÂÇô‰ªΩÊ™îÊ°à");
                        }
                    } catch (err) { notify("ËÆÄÂèñÂ§±ÊïóÔºåË´ãÁ¢∫Ë™çÊ™îÊ°àÊ†ºÂºè"); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            // 2. CSV ÂåØÂá∫ (Export for Google Sheets)
            const handleExportCSV = () => {
                const bom = "\uFEFF"; // UTF-8 BOM for Excel
                const header = "Ë®ÇÂñÆÊó•Êúü,È°ßÂÆ¢ÂêçÁ®±,Ê©üÂè∞ÂêçÁ®±,Ê¨æÂºè,Êï∏Èáè,ÂñÆÂÉπ(Êó•Âπ£),ÂñÆÂÉπ(Âè∞Âπ£),Áí∞‰øùË≤ªÂ∞èË®à,Âè∞Âπ£Á∏ΩÈáëÈ°ç,ÊäïÂπ£ÁãÄÊÖã,ÊíøË≤®ÁãÄÊÖã\n";
                const rows = orders.map(o => 
                    `${o.date},${o.customer},${o.productName},${o.variant},${o.qty},${o.unitPriceJPY},${o.unitPriceTWD},${o.ecoFeeTotal},${o.customerTotalTWD},${o.isPurchased?'Â∑≤Êäï':'Êú™Êäï'},${o.isPicked?'Â∑≤Êíø':'Êú™Êíø'}`
                ).join("\n");
                
                const blob = new Blob([bom + header + rows], { type: "text/csv;charset=utf-8" });
                saveAs(blob, `CuiboGasha_Sheet_${new Date().toISOString().slice(0,10)}.csv`);
                notify("CSV Â∑≤ÂåØÂá∫ÔºåÂèØÂåØÂÖ• Google Sheet");
            };

            // 3. Google Cloud Sync (GAS)
            const handleCloudUpload = async () => {
                if(!apiUrl) { notify("Ë´ãÂÖàË®≠ÂÆö Google Script URL"); return; }
                setIsSyncing(true);
                try {
                    // Google Apps Script usually needs text/plain to avoid CORS preflight issues for simple POSTs
                    await fetch(apiUrl, { 
                        method: 'POST', 
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' }, 
                        body: JSON.stringify({ orders, priceTable, timestamp: new Date().toISOString() }) 
                    });
                    notify("Â∑≤ÁôºÈÄÅ‰∏äÂÇ≥Ë´ãÊ±Ç (Blind Upload)");
                } catch(e) { 
                    console.error(e);
                    notify("‰∏äÂÇ≥Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñ URL"); 
                } finally { 
                    setIsSyncing(false); 
                }
            };

            const handleCloudDownload = async () => {
                if(!apiUrl) { notify("Ë´ãÂÖàË®≠ÂÆö Google Script URL"); return; }
                setIsSyncing(true);
                try {
                    const res = await fetch(apiUrl);
                    if (!res.ok) throw new Error('Network response was not ok');
                    const data = await res.json();
                    
                    if(data.orders){
                        if(confirm(`Èõ≤Á´ØÂÇô‰ªΩÊôÇÈñì: ${data.timestamp}\n\nÁ¢∫ÂÆöË¶Å‰∏ãËºâ‰∏¶Ë¶ÜËìãÁõÆÂâçË≥áÊñôÂóéÔºü`)){
                            setOrders(data.orders);
                            if(data.priceTable) setPriceTable(data.priceTable);
                            notify("Èõ≤Á´ØÂêåÊ≠•ÊàêÂäüÔºÅ");
                            setShowGlobalSettings(false);
                        }
                    } else {
                        notify("Èõ≤Á´ØÁÑ°ÊúâÊïàË≥áÊñô");
                    }
                } catch(e) { 
                    console.error(e);
                    notify("‰∏ãËºâÂ§±ÊïóÔºåË´ãÊ™¢Êü• URL"); 
                } finally { 
                    setIsSyncing(false); 
                }
            };

            // --- 5. È°ßÂÆ¢Ë©≥ÊÉÖÂäüËÉΩ ---
            const handleCopyOrderText = (customer) => {
                if (!customer) return;
                let text = `Ë¶™ÊÑõÁöÑ ${customer.name} ÊÇ®Â•ΩÔºå\n`;
                text += `ÊÇ®Êú¨Ê¨°ÁöÑÊâ≠ËõãÊòéÁ¥∞Â¶Ç‰∏ãÔºö\n\n`;
                customer.items.forEach(item => {
                    text += `${item.productName} ${item.variant !== 'Èö®Ê©ü' ? `(${item.variant})` : ''} x ${item.qty} $${item.customerTotalTWD}`;
                    if(item.ecoFeeTotal > 0) text += ` (Âê´Áí∞‰øùË≤ª)`;
                    text += `\n`;
                });
                text += `----------------\n`;
                text += `Ê∂àË≤ªÁ∏ΩÈ°çÔºö$${customer.totalSpent.toLocaleString()}\n\n`;
                text += `ÂèØ‰ª•ÂÖàÂπ´ÊàëÊê≠Ê≥¢ÂçªÂèØ\n`;
                text += `ÊúâË™§ÁöÑË©±ÔΩûË´ãË∂ïÂø´Ë∑üÊàëË™™ÔºÅ\n`;
                text += `‚Çä‚äπ Ëã•ÊòØÊ≤íÊúâÊºèÊéâÁöÑÂïÜÂìÅ ‚Çä‚äπ\n`;
                text += `Â∞±ÂèØ‰ª•Áõ¥Êé•ÁµêÂ∏≥ÂõâÔºÅ\n`;
                text += `Á∂≤ÂùÄÔºöÔºàÈÄôË£°ÁïôÁµ¶ÊàëËá™Â∑±Ëº∏ÂÖ•Á∂≤ÂùÄÔºâ\n`;
                text += `ÊâæÂà∞Ëá™Â∑±ÂêçÂ≠óÂæåÂÆåÊàê‰∏ãÂñÆÂ∞±ÂèØ‰ª•Âöï\n`;
                text += `êôö Êî∂Âà∞ÊâÄÊúâÈÄ£ÁµêÂæåË´ãÁõ°ÈÄüÂÆåÊàê‰ªòÊ¨æ\n`;
                text += `   ‰∏çË¶ÅËÄΩË™§Âà∞ÊúÄ‰Ω≥ÁöÑË≥ûÂë≥ÊúüÈôêÂî∑\n\n`;
                text += `‚öù p.s. Ââç‰∏ÄÊ¨°ÈÄ£Á∑öÊúâÈñãÁÆ±ÂàÜ‰∫´ÁöÑÊúãÂèã~\n`;
                text += `‰∏ãÂñÆÂæåË´ãÂπ´ÊàëÂÇôË®ª‰∏Ä‰∏ãÔºöÈñãÁÆ±Á¶Æ\n`;
                text += `ùê≠ùê°ùêöùêßùê§ ùê≤ùê®ùêÆ (‚Äû‚Ä¢ ÷ä ‚Ä¢‚Äû)‡©≠`;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    notify("ÊñáÊ°àÂ∑≤Ë§áË£ΩÔºÅ");
                } catch (err) { notify("Ë§áË£ΩÂ§±Êïó"); }
                document.body.removeChild(textArea);
            };

            const handleExportToImage = async (customer) => {
                if (!customer) return;
                setExportTargetCustomer(customer);
                await new Promise(resolve => setTimeout(resolve, 100));
                const element = document.getElementById('hidden-receipt-container');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#FCF4E9', scale: 2 });
                    const dataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `${customer.name}_Êâ≠ËõãÊòéÁ¥∞.png`;
                    link.href = dataUrl;
                    link.click();
                    notify("ÂúñÁâáÂ∑≤‰∏ãËºâ");
                } catch (err) { notify("ÂåØÂá∫Â§±Êïó"); } 
                finally { setExportTargetCustomer(null); }
            };

            // --- 6. ‰ªãÈù¢Ê∏≤Êüì (Render) ---
            return (
                <div className="min-h-screen pb-24">
                    
                    {/* Hidden Receipt */}
                    {exportTargetCustomer && (
                        <div id="hidden-receipt-container">
                            <div className="receipt-card">
                                <div className="receipt-header">
                                    <div className="receipt-title">{exportTargetCustomer.name} ÁöÑÊâ≠ËõãÊ∏ÖÂñÆ</div>
                                    <div className="receipt-subtitle">{new Date().toLocaleString()}</div>
                                </div>
                                <div className="receipt-info">
                                    <span>Ë®ÇÂñÆÁ∑®Ëôü: {Date.now().toString().slice(-6)}</span>
                                    <span>ÂÆ¢Êà∂: {exportTargetCustomer.name}</span>
                                </div>
                                <table className="receipt-table">
                                    <thead>
                                        <tr>
                                            <th className="col-name">Ê©üÂè∞ / Ë¶èÊ†º</th>
                                            <th className="col-price">ÂñÆÂÉπ</th>
                                            <th className="col-qty">Êï∏</th>
                                            <th className="col-total">Â∞èË®à</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {exportTargetCustomer.items.map((item, idx) => (
                                            <tr key={idx}>
                                                <td className="col-name">
                                                    <span className="item-name">{item.productName}</span>
                                                    <span className="item-spec">{item.variant}{item.ecoFeeTotal > 0 && <span className="item-eco">Âê´Áí∞‰øùË≤ª</span>}</span>
                                                </td>
                                                <td className="col-price">${item.unitPriceTWD}</td>
                                                <td className="col-qty">{item.qty}</td>
                                                <td className="col-total">${item.customerTotalTWD}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="receipt-summary">
                                    <div className="summary-total">
                                        <span>Á∏ΩÈáëÈ°ç:</span>
                                        <span>${exportTargetCustomer.totalSpent.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div className="receipt-footer">ÊÑüË¨ùÊÇ®ÁöÑË≥ºË≤∑ÔºÅ(‚Äû‚Ä¢ ÷ä ‚Ä¢‚Äû)‡©≠</div>
                            </div>
                        </div>
                    )}

                    {/* Toast */}
                    {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[300] bg-latte-800 text-cream-50 px-6 py-3 rounded-2xl shadow-xl flex items-center gap-2 animate-in border border-latte-600"><CheckCircle2 size={18} className="text-cream-200" />{notification}</div>}

                    {/* Header */}
                    <div className="bg-latte-500 text-cream-50 p-4 shadow-sm sticky top-0 z-50 flex justify-between items-center max-w-2xl mx-auto shadow-latte-200">
                        <h1 className="text-xl font-bold flex items-center gap-2"><Zap className="fill-cream-100 text-cream-100" /> Cuibo Gasha</h1>
                        <div className="flex gap-2 items-center">
                            <div className="text-xs bg-latte-600 px-2 py-1 rounded-lg">Live</div>
                            <button onClick={()=>setShowGlobalSettings(true)} className="p-1.5 rounded-lg hover:bg-latte-600 transition text-cream-100"><Settings size={20}/></button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="bg-white/90 backdrop-blur-sm border-b border-cream-200 sticky top-[60px] z-40">
                         <div className="flex max-w-2xl mx-auto overflow-x-auto no-scrollbar">
                            {[{id:'input',l:'ÈÄ£Á∑ö',i:Plus},{id:'list',l:'Ê∏ÖÂñÆ',i:ListOrdered},{id:'customers',l:'È°ßÂÆ¢',i:Users},{id:'dashboard',l:'ÂÑÄË°®Êùø',i:LayoutDashboard}].map(t => (
                                <button key={t.id} onClick={() => {setActiveTab(t.id); setSearchQuery('')}} className={`flex-1 py-4 px-2 flex flex-col items-center gap-1 text-[11px] font-bold transition-all ${activeTab === t.id ? 'text-latte-500 border-b-2 border-latte-500 bg-cream-50' : 'text-latte-300'}`}>
                                    <div className="relative">
                                        <t.i size={20}/>
                                        {t.id === 'list' && stats.pendingPick > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border border-white"></span>}
                                    </div>
                                    {t.l}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="max-w-2xl mx-auto p-4 space-y-5">
                        
                        {/* 1. Input Tab */}
                        {activeTab === 'input' && (
                            <div className="space-y-4 animate-in">
                                {/* Ê©üÂè∞Ë®≠ÂÆö */}
                                <div className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="text-xs font-bold text-latte-400 tracking-wider flex items-center gap-1"><Tag size={12}/> Ê©üÂè∞Ë®≠ÂÆö (ÈéñÂÆö‰∏≠)</div>
                                        <button onClick={openPriceEditor} className="text-[10px] text-latte-500 bg-cream-100 px-2 py-1 rounded border border-cream-200 flex items-center gap-1 hover:bg-cream-200 active:scale-95 transition"><Edit size={10}/> Á∑®ËºØÂÉπÊ†º</button>
                                    </div>
                                    <input 
                                        type="text" 
                                        placeholder="Ëº∏ÂÖ•Ê©üÂè∞ÂêçÁ®± (‰æã: Âêâ‰ºäÂç°Âìá)" 
                                        className="w-full text-lg font-bold border-b-2 border-cream-200 focus:border-latte-400 outline-none pb-2 mb-4 placeholder-latte-300 bg-transparent text-latte-800"
                                        value={currentMachine.name}
                                        onChange={e => setCurrentMachine({...currentMachine, name: e.target.value})}
                                    />
                                    
                                    {/* ÂÉπÊ†ºÊåâÈàï */}
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {Object.keys(priceTable).map(Number).sort((a,b)=>a-b).map(price => (
                                            <button 
                                                key={price}
                                                onClick={() => handlePriceSelect(price)}
                                                className={`py-2 rounded-xl text-sm font-bold transition-all ${currentMachine.priceJPY === price ? 'price-btn-active' : 'price-btn'}`}
                                            >
                                                ¬•{price}
                                            </button>
                                        ))}
                                    </div>
                                    
                                    <div className="flex justify-between items-center bg-cream-50 p-3 rounded-2xl border border-cream-200">
                                        <div className="text-xs text-latte-400 font-bold">Ëá™ÂãïÊèõÁÆó</div>
                                        <div className="font-black text-latte-600 flex items-baseline gap-1">
                                            <span className="text-sm font-normal text-latte-400">¬•{currentMachine.priceJPY} =</span>
                                            <span className="text-xl">NT${currentMachine.priceTWD}</span>
                                        </div>
                                    </div>

                                    <div className="mt-3">
                                        <input 
                                            type="text" 
                                            placeholder="Ê¨æÂºè (È†êË®≠Èö®Ê©ü)" 
                                            className="w-full text-sm bg-cream-50 rounded-xl p-3 outline-none text-latte-800"
                                            value={currentMachine.variant}
                                            onChange={e => setCurrentMachine({...currentMachine, variant: e.target.value})}
                                        />
                                    </div>
                                </div>

                                {/* ÂñäÂñÆÂç°Áâá */}
                                <div className="bg-white rounded-3xl p-5 shadow-lg border-2 border-latte-200">
                                    <div className="flex items-center gap-3 mb-5">
                                        <div className="w-10 h-10 bg-cream-100 rounded-full flex items-center justify-center text-latte-400"><User size={20}/></div>
                                        <input 
                                            type="text" 
                                            placeholder="Ë™∞Ë¶ÅË≤∑? (Ëº∏ÂÖ•È°ßÂÆ¢Âêç)" 
                                            className="flex-1 bg-cream-50 rounded-xl py-3 px-4 font-bold text-lg outline-none focus:ring-2 ring-latte-300 text-latte-800"
                                            value={inputCustomer}
                                            onChange={e => setInputCustomer(e.target.value)}
                                        />
                                    </div>

                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3 bg-cream-50 rounded-full p-1 border border-cream-200">
                                            <button onClick={() => setInputQty(Math.max(1, inputQty-1))} className="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-latte-400 active:scale-90 transition"><ArrowRight size={18} className="rotate-180"/></button>
                                            <span className="text-xl font-black w-8 text-center text-latte-800">{inputQty}</span>
                                            <button onClick={() => setInputQty(inputQty+1)} className="w-10 h-10 rounded-full bg-latte-500 text-white shadow-md flex items-center justify-center active:scale-90 transition"><Plus size={18}/></button>
                                        </div>
                                        <button 
                                            onClick={() => setIsEco(!isEco)}
                                            className={`flex flex-col items-center justify-center px-4 py-2 rounded-2xl border-2 transition-all ${isEco ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : 'border-cream-200 text-latte-300 bg-white'}`}
                                        >
                                            <span className="text-[10px] font-bold">ÊãÜÊÆº/Áí∞‰øù</span>
                                            <span className="font-bold text-sm">+{isEco ? `$${ECO_FEE*inputQty}` : '$0'}</span>
                                        </button>
                                    </div>

                                    <button onClick={addOrder} className="w-full bg-latte-800 text-cream-50 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-latte-800/20 active:scale-98 transition flex items-center justify-center gap-2 hover:brightness-110">
                                        <span>Âä†ÂÖ•Ê∏ÖÂñÆ</span>
                                        <span className="bg-white/20 px-2 py-0.5 rounded text-sm">
                                            ${(currentMachine.priceTWD * inputQty) + (isEco ? ECO_FEE * inputQty : 0)}
                                        </span>
                                    </button>
                                </div>
                                {orders.length > 0 && <div className="text-center text-xs text-latte-400 opacity-70">ÂâõÂä†ÂÖ•: {orders[0].customer} - {orders[0].productName} (${orders[0].customerTotalTWD})</div>}
                            </div>
                        )}

                        {/* 2. List Tab */}
                        {activeTab === 'list' && (
                            <div className="space-y-3 animate-in">
                                <div className="relative mb-4">
                                    <input type="text" placeholder="ÊêúÂ∞ãÊ∏ÖÂñÆ..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-white rounded-xl p-3 pl-10 border border-cream-200 outline-none focus:border-latte-400 text-latte-800" />
                                    <Search size={16} className="absolute left-3 top-3.5 text-latte-300" />
                                </div>
                                {filteredOrders.map(o => (
                                    <div key={o.id} className={`bg-white p-4 rounded-3xl shadow-soft border border-cream-200 transition-all ${o.isPicked ? 'opacity-60 bg-cream-50' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <div className="font-bold text-latte-800 text-lg">{o.customer}</div>
                                                <div className="text-xs text-latte-500 font-bold">{o.productName} <span className="text-latte-300 font-normal">({o.variant})</span></div>
                                                <div className="mt-1 text-xs bg-cream-100 inline-block px-2 py-0.5 rounded text-latte-600 font-bold border border-cream-200">¬•{o.unitPriceJPY} x {o.qty}{o.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1">+Áí∞‰øù</span>}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xl font-black text-latte-600">${o.customerTotalTWD}</div>
                                                <button onClick={() => deleteOrder(o.id)} className="text-cream-300 p-2 hover:text-rose-400"><Trash2 size={16}/></button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => toggleStatus(o.id, 'isPurchased')} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 transition-colors border ${o.isPurchased ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><Coins size={14}/> {o.isPurchased ? 'Â∑≤ÊäïÂπ£' : 'Êú™ÊäïÂπ£'}</button>
                                            <button onClick={() => toggleStatus(o.id, 'isPicked')} className={`text-xs py-2 rounded-xl font-bold flex items-center justify-center gap-1 transition-colors border ${o.isPicked ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-cream-50 text-latte-300 border-cream-200'}`}><ShoppingBag size={14}/> {o.isPicked ? 'Â∑≤ÊíøË≤®' : 'Êú™ÊíøË≤®'}</button>
                                        </div>
                                    </div>
                                ))}
                                {filteredOrders.length === 0 && <div className="text-center text-latte-300 py-10">Ê≤íÊúâÁ¨¶ÂêàÁöÑË®ÇÂñÆ</div>}
                            </div>
                        )}

                        {/* 3. Customers Tab */}
                        {activeTab === 'customers' && (
                            <div className="space-y-2 animate-in">
                                <div className="flex justify-between items-center px-2 mb-2">
                                    <span className="text-xs font-bold text-latte-400">ÂÖ± {filteredCustomers.length} ‰ΩçÈ°ßÂÆ¢</span>
                                </div>
                                {filteredCustomers.map(c => (
                                    <div key={c.name} onClick={() => setSelectedCustomerDetail(c)} className="bg-white rounded-3xl p-5 shadow-soft border border-cream-200 flex justify-between items-center cursor-pointer mb-2 active:scale-[0.99] transition-all hover:border-latte-200">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 bg-cream-100 text-latte-600 rounded-full flex items-center justify-center font-bold border border-cream-200 text-lg shadow-sm">{c.name[0]}</div>
                                            <div><h4 className="font-bold text-latte-800 text-lg">{c.name}</h4><p className="text-xs text-latte-400">{c.orderCount} Á≠ÜË®ÇÂñÆ</p></div>
                                        </div>
                                        <div className="text-right">
                                            <p className="font-black text-latte-500 text-lg">${c.totalSpent.toLocaleString()}</p>
                                            <div className="text-[10px] text-latte-300 bg-cream-50 px-2 py-0.5 rounded-lg inline-block">ÈªûÊìäÊü•Áúã</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 4. Dashboard Tab */}
                        {activeTab === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-4 animate-in">
                                <div className="bg-[#D98E73] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10"><Coins size={80}/></div>
                                    <p className="text-xs font-bold opacity-90 tracking-wider">Êó•Âπ£Á∏ΩÊäïÈúÄÊ±Ç</p>
                                    <p className="text-3xl font-black mt-2">¬•{stats.totalJPY.toLocaleString()}</p>
                                    <p className="text-xs opacity-70 mt-1">ÂÖ± {stats.totalCount} È°Ü</p>
                                </div>
                                <div className="bg-[#BF9E85] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10"><DollarSign size={80}/></div>
                                    <p className="text-xs font-bold opacity-90 tracking-wider">È†ê‰º∞Âè∞Âπ£ÁáüÊî∂</p>
                                    <p className="text-3xl font-black mt-2">${stats.totalRevenue.toLocaleString()}</p>
                                </div>
                                <div className="col-span-2 bg-white p-6 rounded-3xl border border-cream-200 shadow-sm flex justify-around text-center">
                                    <div><div className="text-3xl font-black text-latte-400">{stats.pendingPurchase}</div><div className="text-xs text-latte-300 font-bold mt-1">Êú™ÊäïÂπ£</div></div>
                                    <div className="w-px bg-cream-200"></div>
                                    <div><div className="text-3xl font-black text-latte-600">{stats.pendingPick}</div><div className="text-xs text-latte-300 font-bold mt-1">ÂæÖÊíøË≤®</div></div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- Modals --- */}

                    {/* Global Settings Modal */}
                    {showGlobalSettings && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-5 shadow-2xl animate-in max-h-[85vh] overflow-y-auto">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Settings size={20}/> Á≥ªÁµ±Ë®≠ÂÆö</h3>
                                    <button onClick={()=>setShowGlobalSettings(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>

                                {/* Cloud Sync Section */}
                                <div className="space-y-3">
                                    <h4 className="text-xs font-bold text-latte-400 uppercase tracking-wide">Google Èõ≤Á´ØÂêåÊ≠• (Apps Script)</h4>
                                    <input type="text" placeholder="Ëº∏ÂÖ• Google Apps Script URL..." className="w-full bg-cream-50 border border-cream-200 p-3 rounded-xl outline-none text-latte-800 text-xs focus:border-latte-400" value={apiUrl} onChange={e=>setApiUrl(e.target.value)}/>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={handleCloudUpload} disabled={isSyncing} className="bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-md shadow-indigo-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">
                                            {isSyncing ? <Loader2 size={18} className="animate-spin"/> : <Cloud size={18}/>}
                                            <span className="text-xs">‰∏äÂÇ≥Èõ≤Á´Ø (ÂÇô‰ªΩ)</span>
                                        </button>
                                        <button onClick={handleCloudDownload} disabled={isSyncing} className="bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-md shadow-emerald-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 disabled:opacity-50">
                                            {isSyncing ? <Loader2 size={18} className="animate-spin"/> : <RefreshCcw size={18}/>}
                                            <span className="text-xs">‰∏ãËºâÂêåÊ≠• (ÈÇÑÂéü)</span>
                                        </button>
                                    </div>
                                </div>

                                {/* Local Data Management */}
                                <div className="space-y-3 pt-2 border-t border-cream-100">
                                    <h4 className="text-xs font-bold text-latte-400 uppercase tracking-wide">Êú¨Ê©üË≥áÊñôÁÆ°ÁêÜ</h4>
                                    
                                    <button onClick={handleExportCSV} className="w-full bg-white border border-latte-200 text-latte-700 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2 active:scale-95 transition">
                                        <FileSpreadsheet size={18} className="text-green-600"/> ÂåØÂá∫ Excel / Sheets (CSV)
                                    </button>

                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={handleExportBackup} className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition">
                                            <FileJson size={16}/> ÂÇô‰ªΩÊ™îÊ°à
                                        </button>
                                        <label className="bg-latte-100 text-latte-600 py-3 rounded-xl font-bold flex items-center justify-center gap-1 active:scale-95 transition cursor-pointer">
                                            <Upload size={16}/> ÈÇÑÂéüÊ™îÊ°à
                                            <input type="file" className="hidden" ref={fileInputRef} onChange={handleImportBackup} accept=".json"/>
                                        </label>
                                    </div>

                                    <button onClick={handleClearAllData} className="w-full bg-rose-50 border border-rose-100 text-rose-500 py-3 rounded-xl font-bold mt-2 flex items-center justify-center gap-2 active:scale-95 transition hover:bg-rose-100">
                                        <Trash2 size={18}/> Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Price Editor Modal */}
                    {showPriceEditor && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[200] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[30px] w-full max-w-md p-6 space-y-4 shadow-2xl animate-in max-h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center border-b border-cream-200 pb-3">
                                    <h3 className="font-bold text-latte-800 text-lg flex items-center gap-2"><Edit size={20}/> ÂÆöÂÉπÁÆ°ÁêÜ</h3>
                                    <button onClick={()=>setShowPriceEditor(false)} className="w-8 h-8 rounded-full bg-cream-200 text-latte-500 flex items-center justify-center"><X size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-2 p-1">
                                    <div className="flex gap-2 text-xs font-bold text-latte-400 px-2">
                                        <span className="flex-1">Êó•Âπ£ (¬•)</span>
                                        <span className="flex-1">Âè∞Âπ£ ($)</span>
                                        <span className="w-8"></span>
                                    </div>
                                    {editingPrices.map(p => (
                                        <div key={p.id} className="flex gap-2 items-center">
                                            <input type="number" placeholder="Êó•Âπ£" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-800 outline-none focus:border-latte-400" value={p.jpy} onChange={e=>updatePriceRow(p.id, 'jpy', e.target.value)}/>
                                            <ArrowRight size={14} className="text-latte-300"/>
                                            <input type="number" placeholder="Âè∞Âπ£" className="flex-1 bg-cream-50 border border-cream-200 p-2 rounded-xl text-center font-bold text-latte-600 outline-none focus:border-latte-400" value={p.twd} onChange={e=>updatePriceRow(p.id, 'twd', e.target.value)}/>
                                            <button onClick={()=>removePriceRow(p.id)} className="w-8 h-8 flex items-center justify-center text-cream-300 hover:text-rose-500 rounded-full hover:bg-rose-50 transition"><Trash2 size={16}/></button>
                                        </div>
                                    ))}
                                    <button onClick={addPriceRow} className="w-full py-3 border border-dashed border-latte-300 rounded-xl text-latte-400 text-sm font-bold hover:bg-cream-50 hover:text-latte-600 transition flex items-center justify-center gap-1"><Plus size={16}/> Êñ∞Â¢ûÂÉπÊ†ºÁ¥öË∑ù</button>
                                </div>
                                <button onClick={savePriceEditor} className="w-full bg-latte-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-latte-600/20 active:scale-95 transition">ÂÑ≤Â≠òË®≠ÂÆö</button>
                            </div>
                        </div>
                    )}

                    {/* Customer Detail Modal */}
                    {selectedCustomerDetail && (
                        <div className="fixed inset-0 bg-latte-900/40 backdrop-blur-[2px] z-[160] flex items-end md:items-center justify-center p-0 md:p-4 animate-in">
                            <div className="bg-white rounded-t-[30px] md:rounded-3xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl">
                                <div className="p-6 border-b border-cream-200 flex justify-between items-start bg-cream-50 rounded-t-[30px] md:rounded-t-3xl">
                                    <div><h3 className="text-xl font-bold text-latte-800 flex items-center gap-2"><User size={20}/> {selectedCustomerDetail.name}</h3><div className="text-xs text-latte-500 font-bold mt-2 bg-white px-2 py-1 rounded-lg border border-cream-200 inline-block shadow-sm">Á∏ΩÈ°ç: ${selectedCustomerDetail.totalSpent.toLocaleString()}</div></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>handleCopyOrderText(selectedCustomerDetail)} className="p-2.5 bg-white border border-cream-200 rounded-xl flex gap-1 text-xs items-center font-bold text-latte-600 shadow-sm active:scale-95" title="Ë§áË£ΩÊñáÊ°à"><ClipboardList size={18}/> ÊñáÊ°à</button>
                                        <button onClick={()=>handleExportToImage(selectedCustomerDetail)} className="p-2.5 bg-white border border-cream-200 rounded-xl flex gap-1 text-xs items-center font-bold text-latte-600 shadow-sm active:scale-95" title="ÂåØÂá∫ÂúñÁâá"><ImageIcon size={18}/> Â≠òÂúñ</button>
                                        <button onClick={()=>setSelectedCustomerDetail(null)} className="p-2.5 bg-cream-200 text-latte-600 rounded-xl active:scale-95"><X size={18}/></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {selectedCustomerDetail.items.map((item,idx)=>(
                                        <div key={idx} className="flex justify-between items-center p-4 bg-white border border-cream-200 rounded-2xl shadow-sm">
                                            <div><div className="font-bold text-sm text-latte-800">{item.productName}</div><div className="text-xs text-latte-400 mt-1 font-bold">{item.variant} {item.ecoFeeTotal > 0 && <span className="text-emerald-600 ml-1"> (Âê´Áí∞‰øùË≤ª)</span>}</div></div>
                                            <div className="text-right"><div className="text-xs text-latte-400 mb-1">x {item.qty}</div><div className="text-sm text-latte-600 font-black">${item.customerTotalTWD}</div></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
